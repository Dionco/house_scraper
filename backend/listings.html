<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funda Finder | Advanced Search</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <!-- NOTE: Tailwind CDN is used for development. For production, install Tailwind CSS locally -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': {
                            'DEFAULT': '#F97316', // Funda Orange
                            '600': '#EA580C',
                        },
                        'secondary': '#1E293B',
                        'light': '#F8FAFC',
                        'gray': {
                            '100': '#F1F5F9',
                            '200': '#E2E8F0',
                            '300': '#CBD5E1',
                            '400': '#94A3B8',
                            '500': '#64748B',
                            '700': '#334155',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }
        .sticky-sidebar { position: sticky; top: 2rem; max-height: calc(100vh - 4rem); overflow-y: auto; }
        /* Custom scrollbar for the sidebar */
        .sticky-sidebar::-webkit-scrollbar { width: 6px; }
        .sticky-sidebar::-webkit-scrollbar-track { background: transparent; }
        .sticky-sidebar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 3px; }
        .sticky-sidebar::-webkit-scrollbar-thumb:hover { background: #cbd5e1; }
        /* Custom styles for details/summary accordion */
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        
        /* Custom styles for wizard form elements */
        .form-checkbox {
            width: 1rem;
            height: 1rem;
            color: #F97316;
            border: 1px solid #D1D5DB;
            border-radius: 0.25rem;
        }
        .form-checkbox:focus {
            outline: 2px solid #F97316;
            outline-offset: 2px;
        }
        .wizard-step {
            min-height: 400px;
            opacity: 0;
            transform: translateX(20px);
            transition: all 0.3s ease-in-out;
        }
        .wizard-step:not(.hidden) {
            opacity: 1;
            transform: translateX(0);
        }
        .location-option {
            transition: all 0.2s ease-in-out;
        }
        .location-option:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .location-radio {
            transition: all 0.2s ease-in-out;
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        details > summary .chevron { transition: transform 0.2s ease-in-out; }
        details[open] > summary .chevron { transform: rotate(90deg); }
        /* Custom checkbox styles */
        .form-checkbox { appearance: none; -webkit-appearance: none; height: 1.25rem; width: 1.25rem; border: 1px solid #cbd5e1; border-radius: 0.25rem; background-color: #fff; transition: all 0.2s; cursor: pointer; }
        .form-checkbox:checked { background-color: #F97316; border-color: #F97316; background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e"); background-size: 100% 100%; background-position: center; background-repeat: no-repeat; }
        
        /* Hide header when loaded in iframe */
        .iframe-mode .dashboard-header {
            display: none !important;
        }
        
        /* Adjust body padding when header is hidden */
        .iframe-mode body {
            padding-top: 0 !important;
        }
        
        /* Adjust main content when header is hidden */
        .iframe-mode .main-content {
            padding-top: 1rem !important;
        }
    </style>
</head>
<body class="font-sans bg-light">
    <!-- User Authentication Header -->
    <div class="dashboard-header bg-white border-b border-gray-200 shadow-sm">
        <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                    <h1 class="text-xl font-bold text-secondary">Funda Finder</h1>
                </div>
                
                <!-- Authentication Status -->
                <div class="flex items-center gap-4">
                    <!-- Not authenticated -->
                    <div id="auth-not-logged-in" class="flex items-center gap-2">
                        <button id="login-btn" class="text-sm font-medium text-gray-700 hover:text-primary transition-colors">
                            Login
                        </button>
                        <span class="text-gray-300">|</span>
                        <button id="register-btn" class="text-sm font-medium text-primary hover:text-primary-600 transition-colors">
                            Register
                        </button>
                    </div>
                    
                    <!-- Authenticated -->
                    <div id="auth-logged-in" class="flex items-center gap-3 hidden">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center">
                                <span class="text-white font-medium text-sm" id="user-initial">U</span>
                            </div>
                            <span class="text-sm font-medium text-gray-700" id="user-name">User</span>
                        </div>
                        <div class="relative">
                            <button id="user-menu-btn" class="flex items-center gap-1 text-sm text-gray-500 hover:text-gray-700 transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="user-menu" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg ring-1 ring-black ring-opacity-5 z-10 hidden">
                                <div class="py-1">
                                    <a href="#" id="user-profile-link" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Profile Settings</a>
                                    <a href="admin-scraper.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                        Admin Panel
                                    </a>
                                    <div class="border-t border-gray-100"></div>
                                    <a href="#" id="logout-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="main-content max-w-8xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 py-8">

            <aside class="lg:col-span-3 sidebar-decorative">
                <div class="sticky-sidebar pr-4">
                    <!-- Authentication Notice -->
                    <div id="auth-notice" class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg hidden">
                        <div class="flex items-center gap-2 text-blue-800">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="text-sm font-medium">Login to save and manage your search profiles</span>
                        </div>
                    </div>

                    <div class="mb-6 p-4 bg-white rounded-lg border shadow-sm">
                        <div class="flex items-center justify-between mb-3">
                            <h2 class="text-lg font-bold text-secondary">Search Profiles</h2>
                            <button id="toggle-profile-actions" class="p-1 rounded-md hover:bg-gray-100 transition-colors hidden">
                                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zM12 13a1 1 0 110-2 1 1 0 010 2zM12 20a1 1 0 110-2 1 1 0 010 2z"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Profile Selection Dropdown with Active Profile Info -->
                        <div class="mb-3">
                            <div class="relative">
                                <select id="profile-select" class="block appearance-none w-full bg-gray-50 border border-gray-200 text-gray-700 py-2.5 px-3 pr-8 rounded-lg text-sm focus:outline-none focus:bg-white focus:border-primary transition duration-200">
                                    <option value="">Select a saved profile...</option>
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 6.757 7.586 5.343 9z"/></svg>
                                </div>
                            </div>
                            
                            <!-- Active Profile Details (shown when profile is selected) -->
                            <div id="active-profile-info" class="hidden mt-2 p-3 bg-primary/5 border border-primary/20 rounded-lg">
                                <div class="text-xs text-gray-500" id="active-profile-emails">No emails set</div>
                                <div class="text-xs text-green-600 font-medium mt-1" id="active-profile-new-today">
                                    <span class="inline-flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <span id="new-today-count">0</span> new today
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Edit Search Profile Button -->
                        <div id="edit-search-profile-container" class="hidden mb-3">
                            <button id="edit-search-profile-btn" class="w-full flex items-center justify-center gap-2 px-3 py-2 bg-white border border-primary text-primary text-sm font-medium rounded-lg hover:bg-primary/5 transition duration-200">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                                Edit Search Profile
                            </button>
                        </div>

                        <!-- Save new profile action -->
                        <div class="mt-3 pt-3 border-t border-gray-100">
                            <button id="create-new-profile-btn" class="w-full flex items-center justify-center gap-2 px-3 py-2 bg-primary text-white text-sm font-medium rounded-lg hover:bg-primary-600 transition duration-200">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                Create New Search Profile
                            </button>
                        </div>

                        <!-- Scrape for Updates Button (no form wrapper) -->
                        <div class="mb-4 mt-6">
                            <button type="button" id="scrape-updates-btn" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-primary text-white font-semibold rounded-lg shadow hover:bg-primary-600 focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                                <span>Scrape for Updates</span>
                            </button>
                        </div>
                    
                    <!-- Hidden form for compatibility with existing JavaScript -->
                    <form id="scrape-filter-form" style="display: none;">
                        <!-- Empty form - actual filters are now managed in the edit profile modal -->
                    </form>
                </div>
            </aside>

            <main class="lg:col-span-9">
                 <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
                    <div class="bg-white border border-gray-200 rounded-xl p-4 text-center">
                        <span class="text-2xl font-bold block text-secondary" id="total-listings">-</span>
                        <span class="text-sm text-gray-500">Total Listings</span>
                    </div>
                    <div class="bg-white border border-gray-200 rounded-xl p-4 text-center">
                        <span class="text-2xl font-bold block text-secondary" id="avg-price">-</span>
                        <span class="text-sm text-gray-500">Avg Price</span>
                    </div>
                    <div class="bg-white border border-gray-200 rounded-xl p-4 text-center">
                        <span class="text-2xl font-bold block text-secondary" id="new-today">-</span>
                        <span class="text-sm text-gray-500">New Today</span>
                    </div>
                </div>
                <div class="text-center py-24" id="loading-live" style="display: block;">
                    <div class="w-10 h-10 border-4 border-gray-200 border-t-primary rounded-full spinner mx-auto"></div>
                    <p class="mt-4 text-gray-500">Loading initial listings...</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6" id="listings-live" style="display: none;"></div>
            </main>
        </div>
    </div>

    <script>
        // --- GLOBAL VARIABLES ---
        
        // --- NOTIFICATION SYSTEM ---
        function showNotification(message, type = 'info', duration = 5000) {
            const notificationContainer = document.getElementById('notification-container');
            const notification = document.createElement('div');
            
            const iconMap = {
                'success': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>',
                'error': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>',
                'warning': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path></svg>',
                'info': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
            };
            
            const colorMap = {
                'success': 'bg-green-50 border-green-200 text-green-800',
                'error': 'bg-red-50 border-red-200 text-red-800',
                'warning': 'bg-yellow-50 border-yellow-200 text-yellow-800',
                'info': 'bg-blue-50 border-blue-200 text-blue-800'
            };
            
            notification.className = `flex items-center gap-3 p-4 rounded-lg border shadow-lg ${colorMap[type]} transform transition-all duration-300 translate-x-full opacity-0`;
            notification.innerHTML = `
                <div class="flex-shrink-0">${iconMap[type]}</div>
                <div class="flex-1 text-sm font-medium">${message}</div>
                <button onclick="this.parentElement.remove()" class="flex-shrink-0 p-1 rounded-full hover:bg-black/10 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            `;
            
            notificationContainer.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full', 'opacity-0');
            }, 10);
            
            // Auto remove
            if (duration > 0) {
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.classList.add('translate-x-full', 'opacity-0');
                        setTimeout(() => notification.remove(), 300);
                    }
                }, duration);
            }
        }
        
        function showConfirmation(title, message, onConfirm, confirmButtonText = 'Confirm', confirmButtonClass = 'bg-red-500 hover:bg-red-600') {
            const modal = document.getElementById('confirmation-modal');
            const titleEl = document.getElementById('confirmation-title');
            const messageEl = document.getElementById('confirmation-message');
            const confirmBtn = document.getElementById('confirmation-confirm');
            const cancelBtn = document.getElementById('confirmation-cancel');
            
            titleEl.textContent = title;
            messageEl.textContent = message;
            confirmBtn.textContent = confirmButtonText;
            confirmBtn.className = `px-4 py-2 rounded text-white ${confirmButtonClass}`;
            
            modal.classList.remove('hidden');
            
            const handleConfirm = () => {
                modal.classList.add('hidden');
                onConfirm();
                confirmBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
            };
            
            const handleCancel = () => {
                modal.classList.add('hidden');
                confirmBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
            };
            
            confirmBtn.addEventListener('click', handleConfirm);
            cancelBtn.addEventListener('click', handleCancel);
        }

        // --- GLOBAL VARIABLES ---
        let currentProfileId = null;
        let profiles = {}; // Store profiles fetched from API
        let isProfileActionsExpanded = false;

        // --- GLOBAL FUNCTIONS ---
        
        // Example of how to call saveListing (assuming it sends to a backend to save favorited listings)
        function saveListing(fundaUrl) {
            console.log(`Saving listing: ${fundaUrl}`);
            // In a real application, you'd send this to your backend
            // fetch('/api/save-listing', {
            //     method: 'POST',
            //     headers: { 'Content-Type': 'application/json' },
            //     body: JSON.stringify({ url: fundaUrl, profileId: currentProfileId }) // Optionally associate with profile
            // }).then(response => {
            //     if (response.ok) showNotification('Listing saved!', 'success');
            //     else showNotification('Failed to save listing.', 'error');
            // }).catch(error => console.error('Error saving listing:', error));
            showNotification('Listing save functionality (backend) not implemented in this example.', 'info');
        }

        // --- MAPPING & RENDERING (No changes from previous version) ---
        function mapLegacyListing(listing) {
            // Prefer address.street_name, and split house number if needed
            let full_street = listing['address.street_name'] || listing.street_name || listing.address || '';
            let street_name = full_street;
            let house_number = listing['address.house_number'] || listing.house_number || '';
            // If house_number is missing/null/empty, try to extract from street_name
            if (full_street && (!house_number || house_number === null)) {
                const match = full_street.match(/^(.*?)(\s+\d.*)$/);
                if (match) {
                    street_name = match[1].trim();
                    house_number = match[2].trim();
                } else {
                    // If no match, just use the full street as street_name, blank house_number
                    street_name = full_street;
                    house_number = '';
                }
            }
            // If house_number is still empty, just show the full street as street_name
            if (!house_number) {
                street_name = full_street;
            }
            const postal_code = listing['address.postal_code'] || listing.postal_code || listing.area_code || '';
            const city = listing['address.city'] || listing.city || '';
            const rent_price = listing['price.rent_price'] || listing.rent_price || listing.price;
            const rent_price_type = listing['price.rent_price_type'] || listing.rent_price_type || 'per month';
            const floor_area = listing.floor_area || listing['floor_area'] || listing.area;
            const number_of_bedrooms = listing.number_of_bedrooms || listing['number_of_bedrooms'] || listing.bedrooms;
            const energy_label = listing.energy_label || listing['energy_label'];
            const publish_date = listing.publish_date || listing['publish_date'] || listing.listed_since;
            const funda_url = listing.funda_url || listing['object_detail_page_relative_url'];
            const image_url = listing.image_url;
            const status = listing.status || null;
            // If we have at least a street_name, show it, else fallback to Unknown Address
            return {
                ...listing,
                street_name: street_name || 'Unknown Address',
                house_number,
                postal_code,
                city,
                rent_price,
                rent_price_type,
                floor_area,
                number_of_bedrooms,
                energy_label,
                publish_date,
                funda_url,
                image_url,
                status
            };
        }

        function renderListingCard(listing) {
            const price = listing.rent_price ? `€${listing.rent_price.toLocaleString('nl-NL')}` : 'Price on request';
            const placeholderImage = `https://via.placeholder.com/400x300.png?text=No+Image+Available`;
            return `
                <div class="bg-white rounded-xl border border-gray-200 overflow-hidden group hover:shadow-xl hover:border-primary/50 transition-all duration-300 flex flex-col">
                    <div class="relative">
                        <img src="${listing.image_url || placeholderImage}" alt="Photo of ${listing.street_name || 'property'}" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='${placeholderImage}';">
                        ${listing.is_new ? `<div class=\"absolute top-3 left-3 bg-accent text-white px-2.5 py-1 rounded-full text-xs font-bold shadow-lg\" style=\"background-color: #10b981;\">✨ NEW</div>` : ''}
                        ${listing.energy_label ? `<div class=\"absolute top-3 right-3 bg-white/90 backdrop-blur-sm text-secondary px-2 py-1 rounded-full text-xs font-bold shadow-md\">⚡ ${listing.energy_label}</div>` : ''}
                    </div>
                    <div class="p-5 flex flex-col flex-grow">
                         <h3 class="font-bold text-lg text-secondary group-hover:text-primary transition-colors pr-4">${listing.street_name || 'Unknown Address'} ${listing.house_number || ''}</h3>
                        <p class="text-sm text-gray-500 mt-1">${listing.postal_code || ''} ${listing.city || ''}</p>
                        <div class="my-5">
                            <span class="text-2xl font-extrabold text-secondary block leading-none">${price}</span>
                            <span class="text-sm text-gray-500">${listing.rent_price_type || 'per month'}</span>
                        </div>
                            <div class="grid grid-cols-2 gap-4 text-sm mb-6">
                            <div><span class="text-xs font-semibold uppercase tracking-wide text-gray-400">Area </span><span class="font-semibold text-secondary">${listing.floor_area || '-'} m²</span></div>
                            <div><span class="text-xs font-semibold uppercase tracking-wide text-gray-400">Bedrooms </span><span class="font-semibold text-secondary">${listing.number_of_bedrooms || '-'}</span></div>
                        </div>
                        <div class="flex gap-2 flex-col sm:flex-row mt-auto pt-4 border-t border-gray-100">
                            <a href="${listing.funda_url || '#'}" target="_blank" class="flex-1 inline-flex items-center justify-center gap-2 px-4 py-2 bg-primary text-white font-semibold text-sm rounded-lg hover:bg-primary-600">View on Funda</a>
                            <button class="inline-flex items-center justify-center px-4 py-2 bg-gray-100 text-gray-700 font-semibold text-sm rounded-lg hover:bg-gray-200" onclick="saveListing('${listing.funda_url || ''}')">❤️</button>
                        </div>
                    </div>
                </div>`;
        }
        
        // --- GLOBAL VARIABLES ---
        // window.authManager will be initialized in the authentication script section
        
        // --- EVENT LISTENERS ---

        document.addEventListener('DOMContentLoaded', () => {
            console.log('=== DOM Content Loaded ===');
            
            // --- IFRAME DETECTION AND AUTHENTICATION HANDLING ---
            const isInIframe = window.self !== window.top;
            console.log('Is in iframe:', isInIframe);
            
            if (isInIframe) {
                // Add iframe mode class to hide header
                document.documentElement.classList.add('iframe-mode');
                console.log('Iframe mode enabled - header hidden');
                
                // Set up communication with parent page for authentication
                window.addEventListener('message', function(event) {
                    if (event.origin !== window.location.origin) return;
                    
                    if (event.data.type === 'AUTH_TOKEN') {
                        console.log('Received auth token from parent:', event.data.token ? 'present' : 'missing');
                        if (event.data.token) {
                            localStorage.setItem('authToken', event.data.token);
                            if (event.data.user) {
                                localStorage.setItem('currentUser', JSON.stringify(event.data.user));
                            }
                            
                            // Reinitialize AuthManager with the new token
                            console.log('Reinitializing AuthManager with received token...');
                            if (window.authManager) {
                                // Recreate AuthManager to pick up the new token
                                window.authManager = new AuthManager();
                                console.log('AuthManager reinitialized');
                            }
                            
                            // Load data after authentication is received
                            console.log('Loading data after authentication...');
                            fetchProfiles();
                            fetchListings(null, false);
                        }
                    }
                });
                
                // Request authentication from parent
                window.parent.postMessage({
                    type: 'REQUEST_AUTH',
                    source: 'dashboard'
                }, window.location.origin);
                
                // Also retry the request after a short delay in case parent wasn't ready
                setTimeout(() => {
                    window.parent.postMessage({
                        type: 'REQUEST_AUTH',
                        source: 'dashboard'
                    }, window.location.origin);
                }, 1000);
                
                // Hide authentication elements since parent handles it
                const authElements = document.querySelectorAll('#auth-not-logged-in, #auth-logged-in');
                authElements.forEach(el => el.style.display = 'none');
            }
            
            // --- DOM ELEMENT REFERENCES ---
            console.log('Initializing DOM elements...');
            
            // Main form and layout elements
            const form = document.getElementById('scrape-filter-form');
            const loadingSpinner = document.getElementById('loading-live');
            const listingsContainer = document.getElementById('listings-live');
            const profileSelect = document.getElementById('profile-select');
            
            console.log('DOM elements initialized:', {
                form: !!form,
                loadingSpinner: !!loadingSpinner,
                listingsContainer: !!listingsContainer,
                profileSelect: !!profileSelect
            });
            
            // Active profile info elements
            const activeProfileInfo = document.getElementById('active-profile-info');
            const activeProfileEmails = document.getElementById('active-profile-emails');
            
            // Scrape updates button
            const scrapeUpdatesBtn = document.getElementById('scrape-updates-btn');
            
            // Profile wizard elements
            const profileWizardModal = document.getElementById('profile-wizard-modal');
            const createNewProfileBtn = document.getElementById('create-new-profile-btn');
            const wizardCloseBtn = document.getElementById('wizard-close');
            const wizardPrevBtn = document.getElementById('wizard-prev');
            const wizardNextBtn = document.getElementById('wizard-next');
            const wizardSkipBtn = document.getElementById('wizard-skip');
            const wizardCreateBtn = document.getElementById('wizard-create');
            const wizardCurrentStepSpan = document.getElementById('wizard-current-step');
            const wizardProgress = document.getElementById('wizard-progress');
            
            // Edit search profile modal elements
            const editSearchProfileModal = document.getElementById('edit-search-profile-modal');
            const editSearchProfileBtn = document.getElementById('edit-search-profile-btn');
            const editSearchProfileContainer = document.getElementById('edit-search-profile-container');
            const editProfileClose = document.getElementById('edit-profile-close');
            const editProfileCancel = document.getElementById('edit-profile-cancel');
            const editProfileSave = document.getElementById('edit-profile-save');
            const editProfileDeleteBtn = document.getElementById('edit-profile-delete-btn');
            const editProfileName = document.getElementById('edit-profile-name');
            const editProfileEmails = document.getElementById('edit-profile-emails');
            const editUpdateEmailsBtn = document.getElementById('edit-update-emails-btn');
            const editScraperStatus = document.getElementById('edit-scraper-status');
            const scraperStatus = document.getElementById('scraper-status'); // Add this for compatibility
            const editScrapeIntervalHours = document.getElementById('edit-scrape-interval-hours');
            const editScrapeIntervalMinutes = document.getElementById('edit-scrape-interval-minutes');
            const editUpdateIntervalBtn = document.getElementById('edit-update-interval-btn');
            const editLastScraped = document.getElementById('edit-last-scraped');
            
            // Add wizard interval field event listeners
            const wizardIntervalHours = document.getElementById('wizard-scrape-interval-hours');
            const wizardIntervalMinutes = document.getElementById('wizard-scrape-interval-minutes');
            
            // --- UTILITY FUNCTIONS (moved inside DOMContentLoaded) ---
            function renderListings(listings, emptyMessage) {
                console.log('=== renderListings() called ===');
                console.log('Listings count:', listings.length);
                
                // Always map listings to ensure correct structure
                const mappedListings = listings.map(mapLegacyListing);
                if (typeof debugListingKeys === 'function') {
                    debugListingKeys(mappedListings);
                }
                if (mappedListings.length === 0) {
                    listingsContainer.innerHTML = emptyMessage;
                    // Update stats for empty state
                    updateStats([]);
                    return;
                }
                // Check if any listing is new
                const hasNew = mappedListings.some(l => l.is_new);
                let banner = '';
                if (hasNew) {
                    banner = `<div id="new-listings-banner" class="col-span-full mb-4 p-4 rounded-lg bg-green-100 text-green-900 flex items-center justify-between shadow">
                        <span>✨ <b>New listings have been added!</b> Check out the latest properties below.</span>
                        <button onclick="this.parentElement.style.display='none'" class="ml-4 px-3 py-1 rounded bg-green-200 hover:bg-green-300 text-green-900 font-semibold text-xs">Dismiss</button>
                    </div>`;
                }
                console.log('Setting innerHTML with', mappedListings.length, 'listings');
                listingsContainer.innerHTML = banner + mappedListings.map(renderListingCard).join('');
                // Update stats for this profile
                updateStats(mappedListings);
                console.log('renderListings completed');
            }
            
            function getEmptyStateMessage(isFilter) {
                const icon = isFilter 
                    ? `<svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>`
                    : `<svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>`;
                const title = isFilter ? "No Listings Found" : "No Initial Listings";
                const text = isFilter ? "Try adjusting your filters for a wider search." : "Your local listings file seems to be empty. Use the filters to start a search.";
                return `<div class="md:col-span-2 xl:col-span-3 text-center py-24 bg-white rounded-xl border border-gray-200">${icon}<h3 class="mt-4 text-lg font-medium text-secondary">${title}</h3><p class="mt-1 text-sm text-gray-500">${text}</p></div>`;
            }

            function updateStats(listings) {
                document.getElementById('total-listings').textContent = listings.length;
                const pricedListings = listings.filter(l => typeof l.rent_price === 'number');
                document.getElementById('avg-price').textContent = pricedListings.length > 0 ? `€${Math.round(pricedListings.reduce((sum, l) => sum + l.rent_price, 0) / pricedListings.length).toLocaleString('nl-NL')}` : 'N/A';
                // document.getElementById('new-today').textContent = listings.filter(l => l.publish_date && new Date(l.publish_date).toDateString() === new Date().toDateString()).length;
                document.getElementById('new-today').textContent = listings.filter(l => l.is_new).length;
            }
            
            // --- API & DATA FETCHING FUNCTIONS ---
            async function fetchListings(profileId, isFilter) {
                try {
                    console.log('=== fetchListings() called ===');
                    console.log('Profile ID:', profileId, 'isFilter:', isFilter);
                    console.log('listingsContainer:', !!listingsContainer);
                    console.log('loadingSpinner:', !!loadingSpinner);
                    
                    listingsContainer.style.display = 'none';
                    loadingSpinner.style.display = 'block';
                    let url = '/api/listings';
                    if (profileId) {
                        url += `?profile_id=${encodeURIComponent(profileId)}`;
                    }
                    console.log('Fetching from URL:', url);
                    
                    // Use authenticated request if authManager is available and user is logged in
                    const response = (typeof window.authManager !== 'undefined' && window.authManager.isAuthenticated()) 
                        ? await window.authManager.apiRequest(url)
                        : await fetch(url);
                    
                    console.log('Response status:', response.status);
                    if (!response.ok) throw new Error(`Server error: ${response.statusText}`);
                    const data = await response.json();
                    console.log('Data received:', data);
                    console.log('Listings count:', data.listings ? data.listings.length : 'undefined');
                    renderListings(data.listings, getEmptyStateMessage(isFilter));
                } catch (error) {
                    console.error('Error fetching listings:', error);
                    listingsContainer.innerHTML = `<div class="md:col-span-2 xl:col-span-3 text-center py-24 bg-red-50 rounded-xl border border-red-200 text-red-700">
                        <p class="font-semibold">Error loading listings.</p>
                        <p class="text-sm">Please try again later. Details: ${error.message}</p>
                    </div>`;
                    updateStats([]);
                } finally {
                    loadingSpinner.style.display = 'none';
                    listingsContainer.style.display = 'grid';
                }
            }
            
            /**
             * Fetches all saved profiles from the backend.
             */
            async function fetchProfiles() {
                try {
                    console.log('=== fetchProfiles() called ===');
                    
                    // Check if authManager is available and user is authenticated
                    if (typeof window.authManager !== 'undefined' && window.authManager.isAuthenticated()) {
                        console.log('User authenticated, fetching user profiles');
                        const response = await window.authManager.apiRequest('/api/profiles');
                        console.log('fetchProfiles response status:', response.status);
                        if (!response.ok) throw new Error(`Failed to fetch profiles: ${response.statusText}`);
                        const data = await response.json();
                        console.log('fetchProfiles data received:', data.length, 'profiles');
                        profiles = {}; // Clear existing profiles
                        data.forEach(profile => {
                            profiles[profile.id] = profile; // Store by ID for easy lookup
                            // Log interval values for debugging
                            console.log(`  Profile ${profile.name}: ${profile.scrape_interval_hours}h ${profile.scrape_interval_minutes}m`);
                        });
                    } else {
                        console.log('User not authenticated or authManager not available, clearing profiles');
                        profiles = {};
                    }
                    
                    console.log('Calling renderProfileSelect()...');
                    renderProfileSelect();
                    console.log('fetchProfiles completed successfully');
                } catch (error) {
                    console.error('Error fetching profiles:', error);
                    if (error.message.includes('401')) {
                        // Authentication error - clear profiles
                        profiles = {};
                        renderProfileSelect();
                        showNotification('Please log in to access your search profiles.', 'warning');
                    } else {
                        showNotification('Could not load search profiles. Please try refreshing the page.', 'error');
                    }
                }
            }

            /**
             * Load user data (profiles and listings) after authentication
             */
            async function loadUserData() {
                console.log('Loading user data...');
                try {
                    // Load profiles
                    await fetchProfiles();
                    
                    // Load listings
                    await fetchListings(null, false);
                    
                    console.log('User data loaded successfully');
                } catch (error) {
                    console.error('Error loading user data:', error);
                }
            }

            /**
             * Renders the profiles into the dropdown select element.
             */
            function renderProfileSelect() {
                console.log('=== renderProfileSelect() called ===');
                profileSelect.innerHTML = '<option value="">Select a saved profile...</option>';
                const sortedProfileNames = Object.values(profiles).sort((a, b) => a.name.localeCompare(b.name));
                console.log('Rendering profiles:', sortedProfileNames.length);
                sortedProfileNames.forEach(profile => {
                    const option = document.createElement('option');
                    option.value = profile.id;
                    option.textContent = profile.name;
                    profileSelect.appendChild(option);
                });

                // Set the dropdown to the currently active profile and update the view
                profileSelect.value = currentProfileId;
                updateProfileViewState(currentProfileId);
                console.log('renderProfileSelect completed');
            }

            /**
             * Loads the filters of a selected profile into the form.
             * @param {string} profileId - The ID of the profile to load.
             */
            function loadProfile(profileId) {
                const profile = profiles[profileId];
                if (!profile) {
                    console.warn('Profile not found:', profileId);
                    currentProfileId = null;
                    updateProfileViewState(null);
                    return;
                }

                // Profile is now loaded through the modal - no need to populate form fields
                currentProfileId = profileId;

                // Update all UI elements related to the profile state
                updateProfileViewState(profileId);

                // Optionally, trigger a scrape for the loaded profile immediately
                // form.dispatchEvent(new Event('submit')); 
            }

            /**
             * Centralized function to update the UI based on the current profile selection.
             * @param {string|null} profileId - The ID of the currently selected profile, or null if none.
             */
            function updateProfileViewState(profileId) {
                const profile = profileId ? profiles[profileId] : null;
                if (profile) {
                    // Show active profile info and edit button
                    activeProfileInfo.classList.remove('hidden');
                    editSearchProfileContainer.classList.remove('hidden');
                    activeProfileEmails.textContent = profile.emails && profile.emails.length > 0 
                        ? `${profile.emails.length} email${profile.emails.length > 1 ? 's' : ''} configured`
                        : 'No emails set';

                    // Hide new today count
                    const newTodayCountSpan = document.getElementById('new-today-count');
                    if (newTodayCountSpan) {
                        newTodayCountSpan.textContent = '';
                        // Optionally hide the parent section as well
                        const newTodaySection = document.getElementById('active-profile-new-today');
                        if (newTodaySection) {
                            newTodaySection.style.display = 'none';
                        }
                    }
                    
                    
                    // Update scrape button to show last scraped time
                    updateScrapeButtonDisplay();

                } else {
                    // Hide active profile info and edit button
                    activeProfileInfo.classList.add('hidden');
                    editSearchProfileContainer.classList.add('hidden');
                    
                    // Clear new today count
                    const newTodayCountSpan = document.getElementById('new-today-count');
                    if (newTodayCountSpan) {
                        newTodayCountSpan.textContent = '0';
                    }
                    
                    // Disable buttons
                    
                    // Reset scrape button to default display
                    scrapeUpdatesBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                        </svg>
                        <span>Scrape for Updates</span>
                    `;
                }
            }

            /**
             * Updates the scrape button display to show last scraped time.
             */
            function updateScrapeButtonDisplay() {
                if (!currentProfileId || !profiles[currentProfileId]) {
                    scrapeUpdatesBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                        </svg>
                        <span>Scrape for Updates</span>
                    `;
                    return;
                }

                let lastScrapedTime = 'Never';
                const raw = profiles[currentProfileId].last_scraped;
                if (raw) {
                    let lastScraped;
                    if (typeof raw === 'string') {
                        // ISO string format
                        lastScraped = new Date(raw);
                    } else if (typeof raw === 'number' && raw > 100000) {
                        // Timestamp format (milliseconds since epoch)
                        lastScraped = new Date(raw);
                    }
                    
                    if (lastScraped && !isNaN(lastScraped.getTime())) {
                        lastScrapedTime = `${lastScraped.toLocaleDateString()} ${lastScraped.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                    }
                }
                scrapeUpdatesBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                    </svg>
                    <div class="flex flex-col items-start">
                        <span>Scrape for Updates</span>
                        <span class="text-xs opacity-75">Last: ${lastScrapedTime}</span>
                    </div>
                `;
            }

            /**
             * Gets the current filters from the selected profile.
             * @returns {object} An object containing the current filter settings.
             */
            function getCurrentFilters() {
                if (!currentProfileId || !profiles[currentProfileId]) {
                    return {};
                }
                return profiles[currentProfileId].filters || {};
            }

            // --- OLD PROFILE FUNCTIONS (kept for compatibility with wizard) ---
            
            /**
             * Saves a new search profile (used by wizard).
             */
            async function saveNewProfile() {
                // This function is now primarily used by the wizard
                // The actual save functionality is handled by the wizard
                showNotification('Please use the "Create New Search Profile" wizard to save profiles.', 'info');
            }

            /**
             * Overwrites the currently selected profile (deprecated).
             */
            async function overwriteSelectedProfile() {
                // This functionality is now handled by the edit profile modal
                showNotification('Please use the "Edit Search Profile" button to update profiles.', 'info');
            }

            /**
             * Updates the email addresses for the currently selected profile (deprecated).
             */
            async function updateProfileEmails() {
                // This functionality is now handled by the edit profile modal
                showNotification('Please use the "Edit Search Profile" button to update emails.', 'info');
            }

            // --- PERIODIC SCRAPING FUNCTIONS (deprecated - now handled by modal) ---

            /**
             * Updates the scraping interval for the current profile (deprecated).
             */
            async function updateScrapeInterval() {
                showNotification('Please use the "Edit Search Profile" button to update scraping intervals.', 'info');
            }

            /**
             * Manually triggers a scrape for the current profile (deprecated).
             */
            async function triggerProfileScrape() {
                showNotification('Please use the "Edit Search Profile" button to trigger scrapes.', 'info');
            }

            /**
             * Fetches the current scraper status.
             */
            async function fetchScraperStatus() {
                try {
                    const response = await fetch('/api/scraper/status');
                    if (!response.ok) throw new Error(`Failed to fetch scraper status: ${response.statusText}`);
                    const status = await response.json();
                    
                    // Update scraper status display
                    if (scraperStatus) {
                        scraperStatus.textContent = status.is_running ? 'Active' : 'Stopped';
                        scraperStatus.className = status.is_running 
                            ? 'text-xs px-2 py-1 rounded-full bg-green-100 text-green-800'
                            : 'text-xs px-2 py-1 rounded-full bg-red-100 text-red-800';
                    }
                    
                    return status;
                } catch (error) {
                    console.error('Error fetching scraper status:', error);
                    return { is_running: false, total_jobs: 0, jobs: [] };
                }
            }

            // --- EDIT PROFILE MODAL FUNCTIONS ---

            /**
             * Opens the edit profile modal and populates it with current profile data.
             */
            function openEditProfileModal() {
                if (!currentProfileId) {
                    showNotification('Please select a profile to edit.', 'warning');
                    return;
                }

                const profile = profiles[currentProfileId];
                if (!profile) {
                    console.error('Profile not found for ID:', currentProfileId);
                    showNotification('Profile not found. Please try refreshing the page.', 'error');
                    return;
                }

                console.log('Opening edit modal for profile:', profile.name, 'Data:', profile);

                // Populate profile settings
                editProfileName.value = profile.name;
                editProfileEmails.value = profile.emails ? profile.emails.join(', ') : '';
                
                // Handle interval values with proper validation and logging
                const storedHours = profile.scrape_interval_hours;
                const storedMinutes = profile.scrape_interval_minutes;
                
                // Convert and validate stored values
                let displayHours = 4; // Default
                let displayMinutes = 0; // Default
                
                // Handle hours value
                if (storedHours !== undefined && storedHours !== null) {
                    const hoursNum = parseInt(storedHours);
                    if (!isNaN(hoursNum) && hoursNum >= 0 && hoursNum <= 168) {
                        displayHours = hoursNum;
                    }
                }
                
                // Handle minutes value  
                if (storedMinutes !== undefined && storedMinutes !== null) {
                    const minutesNum = parseInt(storedMinutes);
                    if (!isNaN(minutesNum) && minutesNum >= 0 && minutesNum <= 59) {
                        displayMinutes = minutesNum;
                    }
                }
                
                // Set the input values
                editScrapeIntervalHours.value = displayHours;
                editScrapeIntervalMinutes.value = displayMinutes;
                
                // Log for debugging
                console.log(`Profile ${profile.name} interval: stored(${storedHours}h, ${storedMinutes}m) -> display(${displayHours}h, ${displayMinutes}m)`);
                
                // Update the button state
                if (editUpdateIntervalBtn) {
                    editUpdateIntervalBtn.disabled = true; // Start disabled since no changes made yet
                }

                // Populate search filters
                populateModalFilters(profile.filters || {});

                // Update status displays
                if (editScraperStatus) {
                    editScraperStatus.textContent = 'Active';
                    editScraperStatus.className = 'text-xs px-2 py-1 rounded-full bg-green-100 text-green-800';
                }

                // Update last scraped display
                if (editLastScraped) {
                    // Handle both timestamp numbers and ISO strings
                    if (profile.last_scraped) {
                        let lastScraped;
                        if (typeof profile.last_scraped === 'string') {
                            // ISO string format
                            lastScraped = new Date(profile.last_scraped);
                        } else if (typeof profile.last_scraped === 'number' && profile.last_scraped > 100000) {
                            // Timestamp format (milliseconds since epoch)
                            lastScraped = new Date(profile.last_scraped);
                        }
                        
                        if (lastScraped && !isNaN(lastScraped.getTime())) {
                            editLastScraped.textContent = `Last scraped: ${lastScraped.toLocaleDateString()} ${lastScraped.toLocaleTimeString()}`;
                        } else {
                            editLastScraped.textContent = 'Last scraped: Never';
                        }
                    } else {
                        editLastScraped.textContent = 'Last scraped: Never';
                    }
                }

                // Enable/disable buttons
                editUpdateEmailsBtn.disabled = false;
                editUpdateIntervalBtn.disabled = false;
                editProfileDeleteBtn.disabled = false;
                editProfileSave.disabled = false;

                // Show modal
                editSearchProfileModal.classList.remove('hidden');
            }

            /**
             * Populates the modal filter fields with the given filters object.
             */
            function populateModalFilters(filters) {
                // Basic search
                document.getElementById('edit-keyword').value = filters.keyword || '';
                document.getElementById('edit-city').value = filters.city || '';
                
                // Price & Type
                document.getElementById('edit-min-price').value = filters.min_price || '';
                document.getElementById('edit-max-price').value = filters.max_price || '';
                
                // Property types
                document.getElementById('edit-property-woonhuis').checked = filters.property_type && filters.property_type.includes('woonhuis');
                document.getElementById('edit-property-appartement').checked = filters.property_type && filters.property_type.includes('appartement');
                document.getElementById('edit-property-parkeergelegenheid').checked = filters.property_type && filters.property_type.includes('parkeergelegenheid');
                
                // Area & Layout
                document.getElementById('edit-min-area').value = filters.min_area || '';
                document.getElementById('edit-max-area').value = filters.max_area || '';
                document.getElementById('edit-min-rooms').value = filters.min_rooms || '';
                document.getElementById('edit-max-rooms').value = filters.max_rooms || '';
                document.getElementById('edit-min-bedrooms').value = filters.min_bedrooms || '';
                document.getElementById('edit-max-bedrooms').value = filters.max_bedrooms || '';
                
                // Availability & Conditions
                document.getElementById('edit-listed-since').value = filters.listed_since || '';
                document.getElementById('edit-rental-furnished').checked = filters.rental_condition && filters.rental_condition.includes('furnished');
                document.getElementById('edit-rental-partially-furnished').checked = filters.rental_condition && filters.rental_condition.includes('partially_furnished');
                document.getElementById('edit-rental-indefinite').checked = filters.rental_agreement && filters.rental_agreement.includes('indefinite');
                document.getElementById('edit-rental-temporary').checked = filters.rental_agreement && filters.rental_agreement.includes('temporary');
                
                // Features
                document.getElementById('edit-energy-label').value = filters.energy_label || '';
                document.getElementById('edit-outdoor-garden').checked = filters.outdoor_space && filters.outdoor_space.includes('garden');
                document.getElementById('edit-outdoor-balcony').checked = filters.outdoor_space && filters.outdoor_space.includes('balcony');
                document.getElementById('edit-outdoor-roof-terrace').checked = filters.outdoor_space && filters.outdoor_space.includes('roof_terrace');
                document.getElementById('edit-parking-private').checked = filters.parking && filters.parking.includes('private');
                document.getElementById('edit-parking-garage').checked = filters.parking && filters.parking.includes('garage');
                document.getElementById('edit-accessibility-elevator').checked = filters.accessibility && filters.accessibility.includes('elevator');
                document.getElementById('edit-accessibility-single-floor').checked = filters.accessibility && filters.accessibility.includes('single_floor');
            }

            /**
             * Collects all filter values from the modal fields.
             */
            function collectModalFilters() {
                const filters = {};
                
                // Basic search
                const keyword = document.getElementById('edit-keyword').value.trim();
                if (keyword) filters.keyword = keyword;
                
                const city = document.getElementById('edit-city').value.trim();
                if (city) filters.city = city;
                
                // Price & Type
                const minPrice = document.getElementById('edit-min-price').value;
                if (minPrice) filters.min_price = minPrice;
                
                const maxPrice = document.getElementById('edit-max-price').value;
                if (maxPrice) filters.max_price = maxPrice;
                
                // Property types
                const propertyTypes = [];
                if (document.getElementById('edit-property-woonhuis').checked) propertyTypes.push('woonhuis');
                if (document.getElementById('edit-property-appartement').checked) propertyTypes.push('appartement');
                if (document.getElementById('edit-property-parkeergelegenheid').checked) propertyTypes.push('parkeergelegenheid');
                if (propertyTypes.length > 0) filters.property_type = propertyTypes;
                
                // Area & Layout
                const minArea = document.getElementById('edit-min-area').value;
                if (minArea) filters.min_area = minArea;
                
                const maxArea = document.getElementById('edit-max-area').value;
                if (maxArea) filters.max_area = maxArea;
                
                const minRooms = document.getElementById('edit-min-rooms').value;
                if (minRooms) filters.min_rooms = minRooms;
                
                const maxRooms = document.getElementById('edit-max-rooms').value;
                if (maxRooms) filters.max_rooms = maxRooms;
                
                const minBedrooms = document.getElementById('edit-min-bedrooms').value;
                if (minBedrooms) filters.min_bedrooms = minBedrooms;
                
                const maxBedrooms = document.getElementById('edit-max-bedrooms').value;
                if (maxBedrooms) filters.max_bedrooms = maxBedrooms;
                
                // Availability & Conditions
                const listedSince = document.getElementById('edit-listed-since').value;
                if (listedSince) filters.listed_since = listedSince;
                
                const rentalConditions = [];
                if (document.getElementById('edit-rental-furnished').checked) rentalConditions.push('furnished');
                if (document.getElementById('edit-rental-partially-furnished').checked) rentalConditions.push('partially_furnished');
                if (rentalConditions.length > 0) filters.rental_condition = rentalConditions;
                
                const rentalAgreements = [];
                if (document.getElementById('edit-rental-indefinite').checked) rentalAgreements.push('indefinite');
                if (document.getElementById('edit-rental-temporary').checked) rentalAgreements.push('temporary');
                if (rentalAgreements.length > 0) filters.rental_agreement = rentalAgreements;
                
                // Features
                const energyLabel = document.getElementById('edit-energy-label').value;
                if (energyLabel) filters.energy_label = energyLabel;
                
                const outdoorSpaces = [];
                if (document.getElementById('edit-outdoor-garden').checked) outdoorSpaces.push('garden');
                if (document.getElementById('edit-outdoor-balcony').checked) outdoorSpaces.push('balcony');
                if (document.getElementById('edit-outdoor-roof-terrace').checked) outdoorSpaces.push('roof_terrace');
                if (outdoorSpaces.length > 0) filters.outdoor_space = outdoorSpaces;
                
                const parkingOptions = [];
                if (document.getElementById('edit-parking-private').checked) parkingOptions.push('private');
                if (document.getElementById('edit-parking-garage').checked) parkingOptions.push('garage');
                if (parkingOptions.length > 0) filters.parking = parkingOptions;
                
                const accessibilityOptions = [];
                if (document.getElementById('edit-accessibility-elevator').checked) accessibilityOptions.push('elevator');
                if (document.getElementById('edit-accessibility-single-floor').checked) accessibilityOptions.push('single_floor');
                if (accessibilityOptions.length > 0) filters.accessibility = accessibilityOptions;
                
                return filters;
            }

            /**
             * Closes the edit profile modal.
             */
            function closeEditProfileModal() {
                editSearchProfileModal.classList.add('hidden');
            }

            /**
             * Updates the email addresses for the current profile from the modal.
             */
            async function updateProfileEmailsFromModal() {
                if (!currentProfileId) {
                    showNotification('Please select a profile to update emails for.', 'warning');
                    return;
                }
                const emails = editProfileEmails.value.split(',').map(email => email.trim()).filter(email => email);

                try {
                    const response = await window.authManager.apiRequest(`/api/profiles/${currentProfileId}/email`, {
                        method: 'PUT',
                        body: JSON.stringify({ emails: emails })
                    });
                    if (!response.ok) throw new Error(`Failed to update emails: ${response.statusText}`);
                    const result = await response.json();
                    // Update local profile data
                    if (profiles[currentProfileId]) {
                        profiles[currentProfileId].emails = emails;
                        updateProfileViewState(currentProfileId); // Refresh UI
                    }
                    showNotification('Notification emails updated successfully!', 'success');
                } catch (error) {
                    console.error('Error updating emails:', error);
                    showNotification('Could not update notification emails. Please try again.', 'error');
                }
            }

            /**
             * Updates the scraping interval for the current profile from the modal.
             */
            async function updateScrapeIntervalFromModal() {
                if (!currentProfileId) {
                    showNotification('Please select a profile to update the scraping interval for.', 'warning');
                    return;
                }
                
                const intervalHours = parseInt(editScrapeIntervalHours.value) || 0;
                const intervalMinutes = parseInt(editScrapeIntervalMinutes.value) || 0;
                
                // Validate total interval (must be at least 1 minute)
                const totalMinutes = (intervalHours * 60) + intervalMinutes;
                if (totalMinutes < 1) {
                    showNotification('Please enter a valid interval of at least 1 minute total.', 'warning');
                    return;
                }
                if (totalMinutes > 10080) { // 1 week in minutes
                    showNotification('Interval cannot exceed 1 week.', 'warning');
                    return;
                }

                try {
                    const response = await window.authManager.apiRequest(`/api/profiles/${currentProfileId}`, {
                        method: 'PUT',
                        body: JSON.stringify({ 
                            scrape_interval_hours: intervalHours,
                            scrape_interval_minutes: intervalMinutes
                        })
                    });
                    if (!response.ok) throw new Error(`Failed to update interval: ${response.statusText}`);
                    
                    // Update local profile data
                    if (profiles[currentProfileId]) {
                        profiles[currentProfileId].scrape_interval_hours = intervalHours;
                        profiles[currentProfileId].scrape_interval_minutes = intervalMinutes;
                        updateProfileViewState(currentProfileId); // Refresh UI
                        
                        // If the modal is still open, refresh the displayed values
                        if (!editSearchProfileModal.classList.contains('hidden')) {
                            editScrapeIntervalHours.value = intervalHours;
                            editScrapeIntervalMinutes.value = intervalMinutes;
                            editUpdateIntervalBtn.disabled = true; // Reset button state
                        }
                    }
                    
                    const intervalDesc = intervalHours > 0 && intervalMinutes > 0 
                        ? `${intervalHours} hours and ${intervalMinutes} minutes`
                        : intervalHours > 0 
                            ? `${intervalHours} hours`
                            : `${intervalMinutes} minutes`;
                    showNotification(`Scraping interval updated to ${intervalDesc}.`, 'success');
                } catch (error) {
                    console.error('Error updating scraping interval:', error);
                    showNotification('Could not update scraping interval. Please try again.', 'error');
                }
            }

            /**
             * Saves the profile changes from the modal.
             */
            async function saveProfileChanges() {
                if (!currentProfileId) {
                    showNotification('Please select a profile to save changes for.', 'warning');
                    return;
                }

                const profileName = editProfileName.value.trim();
                if (!profileName) {
                    showNotification('Please enter a profile name.', 'warning');
                    return;
                }

                const profileEmails = editProfileEmails.value.split(',').map(email => email.trim()).filter(email => email);
                const filters = collectModalFilters();

                try {
                    const response = await window.authManager.apiRequest(`/api/profiles/${currentProfileId}`, {
                        method: 'PUT',
                        body: JSON.stringify({ name: profileName, filters, emails: profileEmails })
                    });
                    if (!response.ok) throw new Error(`Failed to update profile: ${response.statusText}`);
                    const result = await response.json();
                    // Update the local profile with the response data
                    profiles[currentProfileId] = {
                        id: currentProfileId,
                        name: result.name,
                        filters: result.filters,
                        emails: result.emails || [],
                        listings: result.listings || []
                    };
                    // Refresh the UI
                    renderProfileSelect();
                    updateProfileViewState(currentProfileId);
                    closeEditProfileModal();
                    showNotification(`Profile "${result.name}" updated successfully!`, 'success');
                } catch (error) {
                    console.error('Error updating profile:', error);
                    showNotification('Could not update profile. Please try again.', 'error');
                }
            }
            
            // Initial data loading - defer for iframe mode to allow authentication
            if (isInIframe) {
                console.log('Iframe mode - waiting for authentication before loading data');
                // Data will be loaded after authentication is received
            } else {
                // Normal mode - load data immediately
                fetchProfiles(); // Load profiles on page load
                fetchListings(null, false); // Fetch initial listings (none selected)
            }

            // Fetch initial scraper status
            fetchScraperStatus();

            // Update scraper status every 30 seconds
            setInterval(fetchScraperStatus, 30000);

            // Refresh listings every 5 minutes if a profile is selected
            setInterval(() => {
                if (currentProfileId) {
                    fetchListings(currentProfileId, false);
                }
            }, 300000); // 5 minutes

            // Create New Search Profile Wizard Button
            createNewProfileBtn.addEventListener('click', () => {
                openWizard();
            });

            // Attach event listeners for the new save profile button
            const saveProfileBtn = document.getElementById('save-profile-btn');
            if (saveProfileBtn) {
                saveProfileBtn.addEventListener('click', saveNewProfile);
            }

            // Edit profile modal event listeners
            editSearchProfileBtn.addEventListener('click', openEditProfileModal);
            editProfileClose.addEventListener('click', closeEditProfileModal);
            editProfileCancel.addEventListener('click', closeEditProfileModal);
            editProfileSave.addEventListener('click', saveProfileChanges);
            editUpdateEmailsBtn.addEventListener('click', updateProfileEmailsFromModal);
            editUpdateIntervalBtn.addEventListener('click', updateScrapeIntervalFromModal);
            editProfileDeleteBtn.addEventListener('click', () => {
                if (!currentProfileId) return;
                
                const profileName = profiles[currentProfileId]?.name || 'this profile';
                showConfirmation(
                    'Delete Profile',
                    `Are you sure you want to delete "${profileName}"? This cannot be undone.`,
                    async () => {
                        try {
                            const response = await window.authManager.apiRequest(`/api/profiles/${encodeURIComponent(currentProfileId)}`, { method: 'DELETE' });
                            if (!response.ok && response.status !== 204) throw new Error('Failed to delete profile');
                            // Remove from local profiles object
                            delete profiles[currentProfileId];
                            // Reset UI
                            currentProfileId = null;
                            profileSelect.value = '';
                            closeEditProfileModal();
                            updateProfileViewState(null);
                            await fetchProfiles();
                            fetchListings(null, false);
                            showNotification('Profile deleted successfully.', 'success');
                        } catch (error) {
                            showNotification('Failed to delete profile.', 'error');
                        }
                    }
                );
            });

            // Enable/disable buttons based on input changes in modal
            editProfileEmails.addEventListener('input', () => {
                if (currentProfileId) {
                    const currentEmails = profiles[currentProfileId].emails ? profiles[currentProfileId].emails.join(', ') : '';
                    editUpdateEmailsBtn.disabled = editProfileEmails.value.trim() === currentEmails;
                }
            });

            // Add event listeners for both hour and minute inputs
            [editScrapeIntervalHours, editScrapeIntervalMinutes].forEach(input => {
                if (input) {
                    input.addEventListener('input', () => {
                        if (currentProfileId && editUpdateIntervalBtn) {
                            const currentHours = profiles[currentProfileId]?.scrape_interval_hours || 4;
                            const currentMinutes = profiles[currentProfileId]?.scrape_interval_minutes || 0;
                            const newHours = parseInt(editScrapeIntervalHours.value) || 0;
                            const newMinutes = parseInt(editScrapeIntervalMinutes.value) || 0;
                            
                            // Enable button if values changed and total is at least 1 minute
                            const totalMinutes = (newHours * 60) + newMinutes;
                            const hasChanged = newHours !== currentHours || newMinutes !== currentMinutes;
                            editUpdateIntervalBtn.disabled = !hasChanged || totalMinutes < 1;
                        }
                    });
                }
            });

            // Close modal when clicking outside
            editSearchProfileModal.addEventListener('click', (e) => {
                if (e.target === editSearchProfileModal) {
                    closeEditProfileModal();
                }
            });

            // Close modal with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !editSearchProfileModal.classList.contains('hidden')) {
                    closeEditProfileModal();
                }
            });

            // Edit profile modal event listeners
            profileSelect.addEventListener('change', (event) => {
                const selectedProfileId = event.target.value;
                currentProfileId = selectedProfileId || null;

                if (currentProfileId) {
                    loadProfile(currentProfileId);
                    fetchListings(currentProfileId, false); // Fetch listings for selected profile
                } else {
                    // If "Select a saved profile..." is chosen, reset everything
                    updateProfileViewState(null); // Hide profile-specific sections
                    fetchListings(null, false); // Show initial/empty state
                }
            });

            // Handle button click for scraping updates
            scrapeUpdatesBtn.addEventListener('click', async (event) => {
                event.preventDefault();
                if (!currentProfileId) {
                    showNotification('Please select a profile to scrape for updates.', 'warning');
                    return;
                }
                const filters = getCurrentFilters();
                try {
                    // Show loading state
                    scrapeUpdatesBtn.disabled = true;
                    scrapeUpdatesBtn.innerHTML = `
                        <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Scraping...
                    `;
                    
                    // POST filters to /api/profiles/{profile_id}/scrape
                    const response = await window.authManager.apiRequest(`/api/profiles/${encodeURIComponent(currentProfileId)}/scrape`, {
                        method: 'POST',
                        body: JSON.stringify({ filters })
                    });
                    if (!response.ok) throw new Error(`Scrape failed: ${response.statusText}`);
                    
                    // Show success message
                    scrapeUpdatesBtn.innerHTML = `
                        <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        Scrape Complete!
                    `;
                    
                    showNotification('Scraping completed successfully!', 'success');
                    
                    // Update the last scraped time in the profile
                    if (profiles[currentProfileId]) {
                        profiles[currentProfileId].last_scraped = new Date().toISOString();
                        updateProfileViewState(currentProfileId);
                    }
                    
                    // Refresh listings for this profile
                    await fetchListings(currentProfileId, true);
                    
                    // Reset button after delay
                    setTimeout(() => {
                        // Show last scraped time in the button text
                        let lastScrapedTime = 'Never';
                        const raw = profiles[currentProfileId]?.last_scraped;
                        if (raw) {
                            let lastScraped;
                            if (typeof raw === 'string') {
                                // ISO string format
                                lastScraped = new Date(raw);
                            } else if (typeof raw === 'number' && raw > 100000) {
                                // Timestamp format (milliseconds since epoch)
                                lastScraped = new Date(raw);
                            }
                            
                            if (lastScraped && !isNaN(lastScraped.getTime())) {
                                lastScrapedTime = `${lastScraped.toLocaleDateString()} ${lastScraped.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                            }
                        }
                        scrapeUpdatesBtn.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                            </svg>
                            <div class="flex flex-col items-start">
                                <span>Scrape for Updates</span>
                                <span class="text-xs opacity-75">Last: ${lastScrapedTime}</span>
                            </div>
                        `;
                        scrapeUpdatesBtn.disabled = false;
                    }, 2000);
                } catch (error) {
                    console.error('Error scraping for updates:', error);
                    showNotification('Could not scrape for updates. Please try again.', 'error');
                    // Reset button with last scraped time
                    let lastScrapedTime = 'Never';
                    const raw = profiles[currentProfileId]?.last_scraped;
                    if (raw) {
                        let lastScraped;
                        if (typeof raw === 'string') {
                            // ISO string format
                            lastScraped = new Date(raw);
                        } else if (typeof raw === 'number' && raw > 100000) {
                            // Timestamp format (milliseconds since epoch)
                            lastScraped = new Date(raw);
                        }
                        
                        if (lastScraped && !isNaN(lastScraped.getTime())) {
                            lastScrapedTime = lastScraped.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        }
                    }
                    scrapeUpdatesBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                        </svg>
                        <div class="flex flex-col items-start">
                            <span>Scrape for Updates</span>
                            <span class="text-xs opacity-75">Last: ${lastScrapedTime}</span>
                        </div>
                    `;
                    scrapeUpdatesBtn.disabled = false;
                }
            });

            // --- PROFILE WIZARD FUNCTIONALITY ---
            
            let currentWizardStep = 1;
            let wizardData = {};
            
            // Initialize wizard event listeners
            createNewProfileBtn.addEventListener('click', () => {
                openWizard();
            });
            
            wizardCloseBtn.addEventListener('click', () => {
                closeWizard();
            });
            
            wizardPrevBtn.addEventListener('click', () => {
                goToPreviousStep();
            });
            
            wizardNextBtn.addEventListener('click', () => {
                goToNextStep();
            });
            
            wizardSkipBtn.addEventListener('click', () => {
                goToNextStep();
            });
            
            wizardCreateBtn.addEventListener('click', () => {
                createProfileFromWizard();
            });
            
            // Location selection handlers
            document.querySelectorAll('.location-option').forEach(option => {
                option.addEventListener('click', () => {
                    selectLocationOption(option);
                });
                
                // Add keyboard navigation
                option.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        selectLocationOption(option);
                    }
                });
                
                // Make options focusable
                option.setAttribute('tabindex', '0');
            });
            
            // Preset button handlers for wizard interval
            document.querySelectorAll('.preset-button').forEach(button => {
                button.addEventListener('click', () => {
                    const hours = parseInt(button.dataset.hours) || 0;
                    const minutes = parseInt(button.dataset.minutes) || 0;
                    
                    if (wizardIntervalHours) wizardIntervalHours.value = hours;
                    if (wizardIntervalMinutes) wizardIntervalMinutes.value = minutes;
                    
                    // Visual feedback
                    button.classList.add('bg-primary', 'text-white');
                    setTimeout(() => {
                        button.classList.remove('bg-primary', 'text-white');
                    }, 200);
                });
            });
            
            // Add keyboard navigation for wizard
            profileWizardModal.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeWizard();
                }
            });
            
            // Wizard functions
            function openWizard() {
                currentWizardStep = 1;
                wizardData = {};
                updateWizardUI();
                profileWizardModal.classList.remove('hidden');
            }
            
            function closeWizard() {
                profileWizardModal.classList.add('hidden');
                currentWizardStep = 1;
                wizardData = {};
                resetWizardForm();
            }
            
            function updateWizardUI() {
                // Update step indicator
                wizardCurrentStepSpan.textContent = currentWizardStep;
                
                // Update progress bar
                const progressPercentage = (currentWizardStep / 4) * 100;
                wizardProgress.style.width = `${progressPercentage}%`;
                
                // Show/hide step content
                document.querySelectorAll('.wizard-step').forEach((step, index) => {
                    if (index + 1 === currentWizardStep) {
                        step.classList.remove('hidden');
                    } else {
                        step.classList.add('hidden');
                    }
                });
                
                // Update navigation buttons
                wizardPrevBtn.classList.toggle('hidden', currentWizardStep === 1);
                wizardNextBtn.classList.toggle('hidden', currentWizardStep === 4);
                wizardCreateBtn.classList.toggle('hidden', currentWizardStep !== 4);
                wizardSkipBtn.classList.toggle('hidden', currentWizardStep === 4);
            }
            
            function selectLocationOption(option) {
                // Remove selection from all options
                document.querySelectorAll('.location-option').forEach(opt => {
                    opt.classList.remove('border-primary', 'bg-primary/10');
                    opt.classList.add('border-gray-200');
                    opt.querySelector('.location-radio').innerHTML = '';
                });
                
                // Add selection to clicked option
                option.classList.remove('border-gray-200');
                option.classList.add('border-primary', 'bg-primary/10');
                option.querySelector('.location-radio').innerHTML = `
                    <div class="w-3 h-3 bg-primary rounded-full"></div>
                `;
                
                // Show/hide relevant input fields
                const locationType = option.dataset.locationType;
                wizardData.locationType = locationType;
                
                document.querySelectorAll('.city-options').forEach(el => {
                    el.style.display = 'none';
                });
                
                if (locationType === 'city') {
                    document.querySelector('.city-options').style.display = 'block';
                }
            }
            
            function goToNextStep() {
                if (validateCurrentStep()) {
                    collectCurrentStepData();
                    currentWizardStep++;
                    updateWizardUI();
                }
            }
            
            function goToPreviousStep() {
                if (currentWizardStep > 1) {
                    currentWizardStep--;
                    updateWizardUI();
                }
            }
            
            function validateCurrentStep() {
                if (currentWizardStep === 1) {
                    if (!wizardData.locationType) {
                        showNotification('Please select a location method.', 'warning');
                        return false;
                    }
                    
                    if (wizardData.locationType === 'city') {
                        const cityInput = document.getElementById('city-input').value.trim();
                        if (!cityInput) {
                            showNotification('Please enter a city name.', 'warning');
                            document.getElementById('city-input').focus();
                            return false;
                        }
                    }
                } else if (currentWizardStep === 4) {
                    const profileName = document.getElementById('wizard-profile-name').value.trim();
                    if (!profileName) {
                        showNotification('Please enter a profile name.', 'warning');
                        document.getElementById('wizard-profile-name').focus();
                        return false;
                    }
                    
                    // Validate email format if provided
                    const emailsInput = document.getElementById('wizard-emails').value.trim();
                    if (emailsInput) {
                        const emails = emailsInput.split(',').map(e => e.trim());
                        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        for (const email of emails) {
                            if (email && !emailRegex.test(email)) {
                                showNotification(`Invalid email format: ${email}`, 'warning');
                                document.getElementById('wizard-emails').focus();
                                return false;
                            }
                        }
                    }
                    
                    // Validate interval (must be at least 1 minute total)
                    const intervalHours = parseInt(document.getElementById('wizard-scrape-interval-hours').value) || 0;
                    const intervalMinutes = parseInt(document.getElementById('wizard-scrape-interval-minutes').value) || 0;
                    const totalMinutes = (intervalHours * 60) + intervalMinutes;
                    
                    if (totalMinutes < 1) {
                        showNotification('Please enter a valid interval of at least 1 minute total.', 'warning');
                        document.getElementById('wizard-scrape-interval-hours').focus();
                        return false;
                    }
                }
                return true;
            }
            
            function collectCurrentStepData() {
                if (currentWizardStep === 1) {
                    // Location data
                    if (wizardData.locationType === 'city') {
                        wizardData.city = document.getElementById('city-input').value.trim();
                    }
                } else if (currentWizardStep === 2) {
                    // Basic requirements
                    wizardData.minPrice = document.getElementById('wizard-min-price').value;
                    wizardData.maxPrice = document.getElementById('wizard-max-price').value;
                    wizardData.minBedrooms = document.getElementById('wizard-min-bedrooms').value;
                    wizardData.maxBedrooms = document.getElementById('wizard-max-bedrooms').value;
                    wizardData.minArea = document.getElementById('wizard-min-area').value;
                    wizardData.maxArea = document.getElementById('wizard-max-area').value;
                } else if (currentWizardStep === 3) {
                    // Detailed filters
                    wizardData.propertyTypes = [];
                    document.querySelectorAll('input[name="wizard-property-type"]:checked').forEach(cb => {
                        wizardData.propertyTypes.push(cb.value);
                    });
                    wizardData.energyLabel = document.getElementById('wizard-energy-label').value;
                    wizardData.hasBalcony = document.getElementById('wizard-balcony').checked;
                    wizardData.hasGarden = document.getElementById('wizard-garden').checked;
                    wizardData.hasRoofTerrace = document.getElementById('wizard-roof-terrace').checked;
                    wizardData.furnished = document.getElementById('wizard-furnished').checked;
                    wizardData.partlyFurnished = document.getElementById('wizard-partly-furnished').checked;
                    wizardData.hasParking = document.getElementById('wizard-parking').checked;
                    wizardData.hasGarage = document.getElementById('wizard-garage').checked;
                    wizardData.hasLift = document.getElementById('wizard-lift').checked;
                    wizardData.hasDisabledAccess = document.getElementById('wizard-disabled-access').checked;
                } else if (currentWizardStep === 4) {
                    // Profile setup
                    wizardData.profileName = document.getElementById('wizard-profile-name').value.trim();
                    wizardData.emails = document.getElementById('wizard-emails').value.trim();
                    wizardData.scrapeIntervalHours = parseInt(document.getElementById('wizard-scrape-interval-hours').value) || 4;
                    wizardData.scrapeIntervalMinutes = parseInt(document.getElementById('wizard-scrape-interval-minutes').value) || 0;
                }
            }
            
            function resetWizardForm() {
                // Reset all form fields
                document.getElementById('city-input').value = '';
                document.getElementById('wizard-min-price').value = '';
                document.getElementById('wizard-max-price').value = '';
                document.getElementById('wizard-min-bedrooms').value = '';
                document.getElementById('wizard-max-bedrooms').value = '';
                document.getElementById('wizard-min-area').value = '';
                document.getElementById('wizard-max-area').value = '';
                document.getElementById('wizard-energy-label').value = '';
                document.getElementById('wizard-profile-name').value = '';
                document.getElementById('wizard-emails').value = '';
                document.getElementById('wizard-scrape-interval-hours').value = '4';
                document.getElementById('wizard-scrape-interval-minutes').value = '0';
                
                // Reset checkboxes
                document.querySelectorAll('input[name="wizard-property-type"]').forEach(cb => cb.checked = false);
                document.getElementById('wizard-balcony').checked = false;
                document.getElementById('wizard-garden').checked = false;
                document.getElementById('wizard-roof-terrace').checked = false;
                document.getElementById('wizard-furnished').checked = false;
                document.getElementById('wizard-partly-furnished').checked = false;
                document.getElementById('wizard-parking').checked = false;
                document.getElementById('wizard-garage').checked = false;
                document.getElementById('wizard-lift').checked = false;
                document.getElementById('wizard-disabled-access').checked = false;
                
                // Reset location selection
                document.querySelectorAll('.location-option').forEach(opt => {
                    opt.classList.remove('border-primary', 'bg-primary/10');
                    opt.classList.add('border-gray-200');
                    opt.querySelector('.location-radio').innerHTML = '';
                });
                
                // Hide all input sections
                document.querySelectorAll('.city-options').forEach(el => {
                    el.style.display = 'none';
                });
            }
            
            async function createProfileFromWizard() {
                if (!validateCurrentStep()) return;
                
                collectCurrentStepData();
                
                // Show loading state
                wizardCreateBtn.disabled = true;
                wizardCreateBtn.innerHTML = `
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                        Creating Profile...
                    </div>
                `;
                
                try {
                    // Convert wizard data to profile format
                    const profileData = convertWizardDataToProfile(wizardData);
                    
                    // Save the profile
                    const response = await window.authManager.apiRequest('/api/profiles', {
                        method: 'POST',
                        body: JSON.stringify(profileData)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.detail || 'Failed to create profile');
                    }
                    
                    const result = await response.json();
                    
                    // Success
                    showNotification(`Profile "${profileData.name}" created successfully!`, 'success');
                    closeWizard();
                    await fetchProfiles(); // Refresh profiles list
                    
                    // Optionally load the newly created profile
                    if (result.profileId) {
                        currentProfileId = result.profileId;
                        profileSelect.value = result.profileId;
                        loadProfile(result.profileId);
                        fetchListings(result.profileId, false);
                    }
                    
                } catch (error) {
                    console.error('Error creating profile:', error);
                    showNotification(`Failed to create profile: ${error.message}`, 'error');
                } finally {
                    // Reset button state
                    wizardCreateBtn.disabled = false;
                    wizardCreateBtn.innerHTML = `
                        <span class="flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Create Profile
                        </span>
                    `;
                }
            }
            
            function convertWizardDataToProfile(data) {
                const profile = {
                    name: data.profileName,
                    emails: data.emails ? data.emails.split(',').map(e => e.trim()).filter(e => e) : [],
                    scrape_interval_hours: data.scrapeIntervalHours || 4,
                    scrape_interval_minutes: data.scrapeIntervalMinutes || 0,
                    filters: {}
                };
                
                // Convert location data
                if (data.locationType === 'city' && data.city) {
                    profile.filters.city = data.city;
                }
                
                // Convert basic requirements
                if (data.minPrice) profile.filters.min_price = parseInt(data.minPrice);
                if (data.maxPrice) profile.filters.max_price = parseInt(data.maxPrice);
                if (data.minBedrooms) profile.filters.min_bedrooms = parseInt(data.minBedrooms);
                if (data.maxBedrooms) profile.filters.max_bedrooms = parseInt(data.maxBedrooms);
                if (data.minArea) profile.filters.min_floor_area = parseInt(data.minArea);
                if (data.maxArea) profile.filters.max_floor_area = parseInt(data.maxArea);
                
                // Convert detailed filters
                if (data.propertyTypes && data.propertyTypes.length > 0) {
                    profile.filters.property_types = data.propertyTypes;
                }
                if (data.energyLabel) profile.filters.energy_label = data.energyLabel;
                if (data.hasBalcony) profile.filters.has_balcony = true;
                if (data.hasGarden) profile.filters.has_garden = true;
                if (data.hasRoofTerrace) profile.filters.has_roof_terrace = true;
                if (data.furnished) profile.filters.furnished = true;
                if (data.partlyFurnished) profile.filters.partly_furnished = true;
                if (data.hasParking) profile.filters.has_parking = true;
                if (data.hasGarage) profile.filters.has_garage = true;
                if (data.hasLift) profile.filters.has_lift = true;
                if (data.hasDisabledAccess) profile.filters.has_disabled_access = true;
                
                return profile;
            }

        }); // End of DOMContentLoaded event handler

    </script>
    
    <!-- Custom Notification System -->
    <div id="notification-container" class="fixed top-4 right-4 z-50 space-y-2"></div>
    
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h2 id="confirmation-title" class="text-lg font-bold mb-3 text-secondary">Confirm Action</h2>
            <p id="confirmation-message" class="text-gray-700 mb-4">Are you sure you want to proceed?</p>
            <div class="flex justify-end gap-2">
                <button type="button" id="confirmation-cancel" class="px-4 py-2 rounded bg-gray-100 text-gray-700 hover:bg-gray-200">Cancel</button>
                <button type="button" id="confirmation-confirm" class="px-4 py-2 rounded bg-red-500 text-white hover:bg-red-600">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Search Profile Modal -->
    <div id="edit-search-profile-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-secondary">Edit Search Profile</h2>
                        <p class="text-sm text-gray-500">Manage your search profile settings</p>
                    </div>
                </div>
                <button id="edit-profile-close" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                    <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Modal Content -->
            <div class="flex-1 overflow-y-auto">
                <!-- Profile Settings Section -->
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-secondary mb-4">Profile Settings</h3>
                    
                    <!-- Profile Name -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Profile Name</label>
                        <input type="text" id="edit-profile-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Enter profile name">
                    </div>

                    <!-- Email Notifications -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email Notifications</label>
                        <div class="flex gap-2">
                            <input type="text" id="edit-profile-emails" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Enter emails, comma separated">
                            <button id="edit-update-emails-btn" class="px-4 py-2 bg-primary text-white text-sm font-medium rounded-lg hover:bg-primary-600 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                Update
                            </button>
                        </div>
                    </div>

                    <!-- Periodic Scraping -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Periodic Scraping</label>
                        <div class="p-4 bg-blue-50 rounded-lg">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-sm font-medium text-gray-700">Status</span>
                                <span id="edit-scraper-status" class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-800">Active</span>
                            </div>
                            <div class="space-y-3">
                                <div class="flex items-center gap-2 flex-wrap">
                                    <label class="text-sm text-gray-600">Interval:</label>
                                    <div class="flex items-center gap-1">
                                        <input type="number" id="edit-scrape-interval-hours" class="w-16 px-2 py-1 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" value="" min="0" max="168">
                                        <span class="text-sm text-gray-500">h</span>
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <input type="number" id="edit-scrape-interval-minutes" class="w-16 px-2 py-1 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" value="0" min="0" max="59">
                                        <span class="text-sm text-gray-500">m</span>
                                    </div>
                                    <button id="edit-update-interval-btn" class="px-3 py-1 text-sm bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-200" disabled>Update</button>
                                </div>
                                <div class="text-xs text-gray-500">
                                    <span>Minimum: 1 minute total. Example: 1h 30m = every 1.5 hours</span>
                                </div>
                                <div class="text-xs text-gray-500">
                                    <span id="edit-last-scraped">Last scraped: Never</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search Filters Section -->
                <div class="p-6 space-y-6">
                    <h3 class="text-lg font-semibold text-secondary mb-4">Search Filters</h3>
                    
                    <!-- Basic Search -->
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Keyword Search</label>
                                <input type="text" id="edit-keyword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="e.g. warmtepomp, airco">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">City</label>
                                <input type="text" id="edit-city" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="e.g. Amsterdam, Rotterdam">
                            </div>
                        </div>
                    </div>

                    <!-- Price & Type -->
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h4 class="font-semibold text-gray-800 mb-3">Price & Type</h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Price Range (€)</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" id="edit-min-price" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="From">
                                    <span class="text-gray-400">-</span>
                                    <input type="number" id="edit-max-price" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="To">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Property Type</label>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                                    <label class="flex items-center gap-2 text-sm">
                                        <input type="checkbox" id="edit-property-woonhuis" class="form-checkbox">
                                        <span>Woonhuis</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-sm">
                                        <input type="checkbox" id="edit-property-appartement" class="form-checkbox">
                                        <span>Appartement</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-sm">
                                        <input type="checkbox" id="edit-property-parkeergelegenheid" class="form-checkbox">
                                        <span>Parkeergelegenheid</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Area & Layout -->
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h4 class="font-semibold text-gray-800 mb-3">Area & Layout</h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Living Area (m²)</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" id="edit-min-area" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="From">
                                    <span class="text-gray-400">-</span>
                                    <input type="number" id="edit-max-area" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="To">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Rooms</label>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="edit-min-rooms" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="From">
                                        <span class="text-gray-400">-</span>
                                        <input type="number" id="edit-max-rooms" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="To">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Bedrooms</label>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="edit-min-bedrooms" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="From">
                                        <span class="text-gray-400">-</span>
                                        <input type="number" id="edit-max-bedrooms" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="To">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Availability & Conditions -->
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h4 class="font-semibold text-gray-800 mb-3">Availability & Conditions</h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Listed Since</label>
                                <select id="edit-listed-since" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <option value="">Any</option>
                                    <option value="1">Today</option>
                                    <option value="3">Last 3 days</option>
                                    <option value="5">Last 5 days</option>
                                    <option value="10">Last 10 days</option>
                                    <option value="30">Last 30 days</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Rental Conditions</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center gap-2 text-sm">
                                            <input type="checkbox" id="edit-rental-furnished" class="form-checkbox">
                                            <span>Furnished</span>
                                        </label>
                                        <label class="flex items-center gap-2 text-sm">
                                            <input type="checkbox" id="edit-rental-partially-furnished" class="form-checkbox">
                                            <span>Partially Furnished</span>
                                        </label>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Rental Agreement</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center gap-2 text-sm">
                                            <input type="checkbox" id="edit-rental-indefinite" class="form-checkbox">
                                            <span>Indefinite</span>
                                        </label>
                                        <label class="flex items-center gap-2 text-sm">
                                            <input type="checkbox" id="edit-rental-temporary" class="form-checkbox">
                                            <span>Temporary</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Features -->
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h4 class="font-semibold text-gray-800 mb-3">Features</h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Min. Energy Label</label>
                                <select id="edit-energy-label" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <option value="">Any</option>
                                    <option value="A_PLUS_PLUS_PLUS_PLUS_PLUS">A+++++</option>
                                    <option value="A_PLUS_PLUS_PLUS_PLUS">A++++</option>
                                    <option value="A_PLUS_PLUS_PLUS">A+++</option>
                                    <option value="A_PLUS_PLUS">A++</option>
                                    <option value="A_PLUS">A+</option>
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="C">C</option>
                                    <option value="D">D</option>
                                    <option value="E">E</option>
                                    <option value="F">F</option>
                                    <option value="G">G</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Outdoor Space</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center gap-2 text-sm">
                                            <input type="checkbox" id="edit-outdoor-garden" class="form-checkbox">
                                            <span>Garden</span>
                                        </label>
                                        <label class="flex items-center gap-2 text-sm">
                                            <input type="checkbox" id="edit-outdoor-balcony" class="form-checkbox">
                                            <span>Balcony</span>
                                        </label>
                                        <label class="flex items-center gap-2 text-sm">
                                            <input type="checkbox" id="edit-outdoor-roof-terrace" class="form-checkbox">
                                            <span>Roof Terrace</span>
                                        </label>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Parking</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center gap-2 text-sm">
                                            <input type="checkbox" id="edit-parking-private" class="form-checkbox">
                                            <span>Private Parking</span>
                                        </label>
                                        <label class="flex items-center gap-2 text-sm">
                                            <input type="checkbox" id="edit-parking-garage" class="form-checkbox">
                                            <span>Garage</span>
                                        </label>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Accessibility</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center gap-2 text-sm">
                                            <input type="checkbox" id="edit-accessibility-elevator" class="form-checkbox">
                                            <span>Elevator</span>
                                        </label>
                                        <label class="flex items-center gap-2 text-sm">
                                            <input type="checkbox" id="edit-accessibility-single-floor" class="form-checkbox">
                                            <span>Single Floor</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="flex justify-between items-center p-6 border-t border-gray-200">
                <button id="edit-profile-delete-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    Delete Profile
                </button>
                <div class="flex gap-2">
                    <button id="edit-profile-cancel" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition duration-200">
                        Cancel
                    </button>
                    <button id="edit-profile-save" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-600 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Create New Search Profile Wizard -->
    <div id="profile-wizard-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[90vh] overflow-hidden flex flex-col">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-secondary">Create New Search Profile</h2>
                        <p class="text-sm text-gray-500">Step <span id="wizard-current-step">1</span> of 4</p>
                    </div>
                </div>
                <button id="wizard-close" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Progress Bar -->
            <div class="px-6 py-4 border-b border-gray-100">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-gray-700">Location</span>
                    <span class="text-sm font-medium text-gray-700">Requirements</span>
                    <span class="text-sm font-medium text-gray-700">Details</span>
                    <span class="text-sm font-medium text-gray-700">Setup</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div id="wizard-progress" class="bg-primary h-2 rounded-full transition-all duration-300" style="width: 25%"></div>
                </div>
            </div>

            <!-- Modal Content -->
            <div class="flex-1 overflow-y-auto">
                
                <!-- Step 1: Location Selection -->
                <div id="wizard-step-1" class="wizard-step p-6">
                    <div class="max-w-2xl mx-auto">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-4m-5 0H3m2 0h4M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                </svg>
                            </div>
                            <h3 class="text-2xl font-bold text-secondary mb-2">Where would you like to search?</h3>
                        </div>

                        <div class="space-y-4">
                            <!-- City Selection -->
                            <div class="location-option border-2 border-gray-200 rounded-xl p-6 cursor-pointer hover:border-primary hover:bg-primary/5 transition-all" data-location-type="city">
                                <div class="flex items-start gap-4">
                                    <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-4m-5 0H3m2 0h4M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <h4 class="font-semibold text-lg text-secondary mb-1">Search by City</h4>
                                        <p class="text-gray-600 mb-3">Search within specific cities or municipalities</p>
                                        <div class="city-options" style="display: none;">
                                            <input type="text" id="city-input" placeholder="Enter city name (e.g., Amsterdam, Utrecht)" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                        </div>
                                    </div>
                                    <div class="location-radio w-5 h-5 border-2 border-gray-300 rounded-full flex-shrink-0"></div>
                                </div>
                            </div>


                        </div>
                    </div>
                </div>

                <!-- Step 2: Basic Requirements -->
                <div id="wizard-step-2" class="wizard-step p-6 hidden">
                    <div class="max-w-2xl mx-auto">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-8 h-8 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                </svg>
                            </div>
                            <h3 class="text-2xl font-bold text-secondary mb-2">What are your main requirements?</h3>
                            <p class="text-gray-600">Set your budget and space needs</p>
                        </div>

                        <div class="space-y-6">
                            <!-- Price Range -->
                            <div class="bg-gray-50 rounded-xl p-6">
                                <h4 class="font-semibold text-lg text-secondary mb-4 flex items-center gap-2">
                                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                    </svg>
                                    Price Range (€)
                                </h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Minimum Price</label>
                                        <input type="number" id="wizard-min-price" placeholder="e.g. 800" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Maximum Price</label>
                                        <input type="number" id="wizard-max-price" placeholder="e.g. 2500" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                    </div>
                                </div>
                            </div>

                            <!-- Bedrooms -->
                            <div class="bg-gray-50 rounded-xl p-6">
                                <h4 class="font-semibold text-lg text-secondary mb-4 flex items-center gap-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                                    </svg>
                                    Bedrooms
                                </h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Minimum Bedrooms</label>
                                        <select id="wizard-min-bedrooms" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                            <option value="">Any</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5+</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Maximum Bedrooms</label>
                                        <select id="wizard-max-bedrooms" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                            <option value="">Any</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5+</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Floor Area -->
                            <div class="bg-gray-50 rounded-xl p-6">
                                <h4 class="font-semibold text-lg text-secondary mb-4 flex items-center gap-2">
                                    <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                                    </svg>
                                    Floor Area (m²)
                                </h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Minimum Area</label>
                                        <input type="number" id="wizard-min-area" placeholder="e.g. 50" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Maximum Area</label>
                                        <input type="number" id="wizard-max-area" placeholder="e.g. 150" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Detailed Filters -->
                <div id="wizard-step-3" class="wizard-step p-6 hidden">
                    <div class="max-w-4xl mx-auto">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
                                </svg>
                            </div>
                            <h3 class="text-2xl font-bold text-secondary mb-2">Additional preferences</h3>
                            <p class="text-gray-600">Fine-tune your search with detailed filters</p>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Property Features -->
                            <div class="space-y-6">
                                <div class="bg-gray-50 rounded-xl p-6">
                                    <h4 class="font-semibold text-lg text-secondary mb-4">Property Type</h4>
                                    <div class="space-y-3">
                                        <label class="flex items-center gap-3">
                                            <input type="checkbox" name="wizard-property-type" value="apartment" class="form-checkbox">
                                            <span class="text-sm">Apartment</span>
                                        </label>
                                        <label class="flex items-center gap-3">
                                            <input type="checkbox" name="wizard-property-type" value="house" class="form-checkbox">
                                            <span class="text-sm">House</span>
                                        </label>
                                        <label class="flex items-center gap-3">
                                            <input type="checkbox" name="wizard-property-type" value="studio" class="form-checkbox">
                                            <span class="text-sm">Studio</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="bg-gray-50 rounded-xl p-6">
                                    <h4 class="font-semibold text-lg text-secondary mb-4">Energy Label</h4>
                                    <select id="wizard-energy-label" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                        <option value="">Any</option>
                                        <option value="A+++">A+++</option>
                                        <option value="A++">A++</option>
                                        <option value="A+">A+</option>
                                        <option value="A">A</option>
                                        <option value="B">B or better</option>
                                        <option value="C">C or better</option>
                                    </select>
                                </div>

                                <div class="bg-gray-50 rounded-xl p-6">
                                    <h4 class="font-semibold text-lg text-secondary mb-4">Outdoor Space</h4>
                                    <div class="space-y-3">
                                        <label class="flex items-center gap-3">
                                            <input type="checkbox" id="wizard-balcony" class="form-checkbox">
                                            <span class="text-sm">Balcony</span>
                                        </label>
                                        <label class="flex items-center gap-3">
                                            <input type="checkbox" id="wizard-garden" class="form-checkbox">
                                            <span class="text-sm">Garden</span>
                                        </label>
                                        <label class="flex items-center gap-3">
                                            <input type="checkbox" id="wizard-roof-terrace" class="form-checkbox">
                                            <span class="text-sm">Roof Terrace</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Amenities & Features -->
                            <div class="space-y-6">
                                <div class="bg-gray-50 rounded-xl p-6">
                                    <h4 class="font-semibold text-lg text-secondary mb-4">Furnishing</h4>
                                    <div class="space-y-3">
                                        <label class="flex items-center gap-3">
                                            <input type="checkbox" id="wizard-furnished" class="form-checkbox">
                                            <span class="text-sm">Furnished</span>
                                        </label>
                                        <label class="flex items-center gap-3">
                                            <input type="checkbox" id="wizard-partly-furnished" class="form-checkbox">
                                            <span class="text-sm">Partly Furnished</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="bg-gray-50 rounded-xl p-6">
                                    <h4 class="font-semibold text-lg text-secondary mb-4">Parking & Storage</h4>
                                    <div class="space-y-3">
                                        <label class="flex items-center gap-3">
                                            <input type="checkbox" id="wizard-parking" class="form-checkbox">
                                            <span class="text-sm">Parking</span>
                                        </label>
                                        <label class="flex items-center gap-3">
                                            <input type="checkbox" id="wizard-garage" class="form-checkbox">
                                            <span class="text-sm">Garage</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="bg-gray-50 rounded-xl p-6">
                                    <h4 class="font-semibold text-lg text-secondary mb-4">Accessibility</h4>
                                    <div class="space-y-3">
                                        <label class="flex items-center gap-3">
                                            <input type="checkbox" id="wizard-lift" class="form-checkbox">
                                            <span class="text-sm">Elevator</span>
                                        </label>
                                        <label class="flex items-center gap-3">
                                            <input type="checkbox" id="wizard-disabled-access" class="form-checkbox">
                                            <span class="text-sm">Disabled Access</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Profile Setup -->
                <div id="wizard-step-4" class="wizard-step p-6 hidden">
                    <div class="max-w-2xl mx-auto">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                            <h3 class="text-2xl font-bold text-secondary mb-2">Profile setup</h3>
                            <p class="text-gray-600">Name your profile and configure notifications</p>
                        </div>

                        <div class="space-y-6">
                            <!-- Profile Name -->
                            <div class="bg-gray-50 rounded-xl p-6">
                                <h4 class="font-semibold text-lg text-secondary mb-4 flex items-center gap-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                    </svg>
                                    Profile Name
                                </h4>
                                <input type="text" id="wizard-profile-name" placeholder="e.g., Amsterdam City Center Search" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-lg">
                            </div>

                            <!-- Email Notifications -->
                            <div class="bg-gray-50 rounded-xl p-6">
                                <h4 class="font-semibold text-lg text-secondary mb-4 flex items-center gap-2">
                                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                    </svg>
                                    Email Notifications
                                </h4>
                                <div class="space-y-3">
                                    <textarea id="wizard-emails" rows="3" placeholder="Enter email addresses separated by commas&#10;e.g., john@example.com, jane@example.com" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent resize-none"></textarea>
                                    <p class="text-sm text-gray-600">You'll receive notifications when new properties matching your criteria are found.</p>
                                </div>
                            </div>

                            <!-- Scraping Frequency -->
                            <div class="bg-gray-50 rounded-xl p-6">
                                <h4 class="font-semibold text-lg text-secondary mb-4 flex items-center gap-2">
                                    <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    Search Frequency
                                </h4>
                                <div class="space-y-4">
                                    <div class="flex items-center gap-4">
                                        <div class="flex items-center gap-1">
                                            <input type="number" id="wizard-scrape-interval-hours" class="w-20 px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" value="4" min="0" max="168">
                                            <span class="text-sm text-gray-600">hours</span>
                                        </div>
                                        <div class="flex items-center gap-1">
                                            <input type="number" id="wizard-scrape-interval-minutes" class="w-20 px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" value="0" min="0" max="59">
                                            <span class="text-sm text-gray-600">minutes</span>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <button type="button" class="preset-button px-3 py-2 text-sm border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" data-hours="0" data-minutes="30">30 min</button>
                                        <button type="button" class="preset-button px-3 py-2 text-sm border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" data-hours="1" data-minutes="0">1 hour</button>
                                        <button type="button" class="preset-button px-3 py-2 text-sm border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" data-hours="2" data-minutes="0">2 hours</button>
                                        <button type="button" class="preset-button px-3 py-2 text-sm border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" data-hours="4" data-minutes="0">4 hours</button>
                                        <button type="button" class="preset-button px-3 py-2 text-sm border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" data-hours="6" data-minutes="0">6 hours</button>
                                        <button type="button" class="preset-button px-3 py-2 text-sm border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" data-hours="12" data-minutes="0">12 hours</button>
                                    </div>
                                </div>
                                <p class="text-sm text-gray-600 mt-3">How often should we check for new properties? Minimum: 1 minute total.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="p-6 border-t border-gray-200 flex items-center justify-between">
                <button id="wizard-prev" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors hidden">
                    <span class="flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        Previous
                    </span>
                </button>
                <div class="flex gap-3">
                    <button id="wizard-skip" class="px-6 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                        Skip this step
                    </button>
                    <button id="wizard-next" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary-600 transition-colors">
                        <span class="flex items-center gap-2">
                            Next
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </span>
                    </button>
                    <button id="wizard-create" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors hidden">
                        <span class="flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Create Profile
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900" id="confirmation-title">Confirm Action</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500" id="confirmation-message">Are you sure you want to proceed?</p>
                </div>
                <div class="items-center px-4 py-3 flex justify-end gap-2">
                    <button id="confirmation-cancel" class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400">Cancel</button>
                    <button id="confirmation-confirm" class="px-4 py-2 rounded text-white bg-red-500 hover:bg-red-600">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Load authentication script -->
    <script src="/static/auth.js"></script>
    
    <script>
        // Initialize authentication
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Initializing authentication...');
            
            // Check if we're in iframe mode
            const isIframe = window.self !== window.top;
            console.log('Is iframe mode:', isIframe);
            
            // Wait for auth.js to load and use the global authManager
            function initializeAuth() {
                if (typeof window.authManager === 'undefined') {
                    console.log('Global authManager not loaded yet, retrying...');
                    setTimeout(initializeAuth, 100);
                    return;
                }
                
                console.log('Using global authManager instance');
                
                try {
                    // Setup authentication event listeners
                    setupAuthEventListeners();
                    
                    // Update UI based on auth state
                    updateAuthUI();
                    
                    // Listen for auth state changes
                    window.authManager.addListener(updateAuthUI);
                    
                    // If in iframe mode, listen for authentication from parent
                    if (isIframe) {
                        setupIframeAuthListener();
                    }
                    
                    console.log('Authentication initialization complete');
                } catch (error) {
                    console.error('Failed to initialize authentication:', error);
                    setTimeout(initializeAuth, 1000); // Retry after 1 second
                }
            }
            
            function setupIframeAuthListener() {
                console.log('Setting up iframe auth listener...');
                
                window.addEventListener('message', async (event) => {
                    if (event.origin !== window.location.origin) {
                        console.log('Ignoring message from different origin:', event.origin);
                        return;
                    }
                    
                    console.log('Received message in dashboard:', event.data);
                    
                    if (event.data.type === 'AUTH_TOKEN' && event.data.token) {
                        console.log('Received auth token in dashboard iframe');
                        
                        try {
                            // Store the token in localStorage
                            localStorage.setItem('accessToken', event.data.token);
                            if (event.data.user) {
                                localStorage.setItem('currentUser', JSON.stringify(event.data.user));
                            }
                            
                            // Reload the authManager state from localStorage
                            console.log('Reloading AuthManager state from localStorage...');
                            window.authManager.loadFromStorage();
                            
                            // Update UI
                            updateAuthUI();
                            
                            // Reload data
                            if (typeof loadUserData === 'function') {
                                await loadUserData();
                            } else {
                                console.log('loadUserData function not available, calling individual fetch functions');
                                if (typeof fetchProfiles === 'function') await fetchProfiles();
                                if (typeof fetchListings === 'function') await fetchListings(null, false);
                            }
                            
                            console.log('Dashboard authenticated successfully');
                        } catch (error) {
                            console.error('Error handling auth token in dashboard:', error);
                        }
                    }
                });
                
                // Request authentication from parent
                console.log('Requesting authentication from parent...');
                window.parent.postMessage({
                    type: 'REQUEST_AUTH',
                    source: 'dashboard'
                }, window.location.origin);
            }
            
            function setupAuthEventListeners() {
                const loginBtn = document.getElementById('login-btn');
                const registerBtn = document.getElementById('register-btn');
                const logoutBtn = document.getElementById('logout-btn');
                const userMenuBtn = document.getElementById('user-menu-btn');
                
                if (loginBtn) {
                    loginBtn.addEventListener('click', () => {
                        // In iframe mode, redirect to parent for authentication
                        if (window.self !== window.top) {
                            window.parent.postMessage({
                                type: 'SHOW_LOGIN',
                                source: 'dashboard'
                            }, window.location.origin);
                        } else {
                            // Direct mode - show authentication modal
                            showAuthModal('login');
                        }
                    });
                }
                
                if (registerBtn) {
                    registerBtn.addEventListener('click', () => {
                        // In iframe mode, redirect to parent for authentication
                        if (window.self !== window.top) {
                            window.parent.postMessage({
                                type: 'SHOW_REGISTER',
                                source: 'dashboard'
                            }, window.location.origin);
                        } else {
                            // Direct mode - show authentication modal
                            showAuthModal('register');
                        }
                    });
                }
                
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', async () => {
                        try {
                            await window.authManager.logout();
                            showNotification('Logged out successfully!', 'success');
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);
                        } catch (error) {
                            showNotification('Error logging out: ' + error.message, 'error');
                        }
                    });
                }
                
                // Setup user menu toggle
                if (userMenuBtn) {
                    userMenuBtn.addEventListener('click', () => {
                        const menu = document.getElementById('user-menu');
                        if (menu) {
                            menu.classList.toggle('hidden');
                        }
                    });
                }
                
                // Close user menu when clicking outside
                document.addEventListener('click', (e) => {
                    const menu = document.getElementById('user-menu');
                    const btn = document.getElementById('user-menu-btn');
                    if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
                        menu.classList.add('hidden');
                    }
                });
            }
            
            function updateAuthUI() {
                const isAuthenticated = window.authManager && window.authManager.isAuthenticated();
                const user = isAuthenticated ? window.authManager.getCurrentUser() : null;
                const notLoggedIn = document.getElementById('auth-not-logged-in');
                const loggedIn = document.getElementById('auth-logged-in');
                const authNotice = document.getElementById('auth-notice');
                
                console.log('Updating auth UI, authenticated:', isAuthenticated, 'user:', user);
                
                if (isAuthenticated && user) {
                    // User is authenticated
                    if (notLoggedIn) notLoggedIn.classList.add('hidden');
                    if (loggedIn) loggedIn.classList.remove('hidden');
                    if (authNotice) authNotice.classList.add('hidden');
                    
                    // Update user display
                    const userName = document.getElementById('user-name');
                    const userInitial = document.getElementById('user-initial');
                    if (userName) userName.textContent = user.username;
                    if (userInitial) userInitial.textContent = user.username.charAt(0).toUpperCase();
                } else {
                    // User is not authenticated
                    if (notLoggedIn) notLoggedIn.classList.remove('hidden');
                    if (loggedIn) loggedIn.classList.add('hidden');
                    if (authNotice) authNotice.classList.remove('hidden');
                }
            }
            
            // Authentication modal functions (for direct mode)
            function showAuthModal(mode) {
                // Only show modal if not in iframe mode
                if (window.self !== window.top) {
                    return;
                }
                
                const authModal = document.getElementById('auth-modal');
                const modalTitle = document.getElementById('modal-title');
                const loginForm = document.getElementById('login-form');
                const registerForm = document.getElementById('register-form');
                const toggleText = document.getElementById('toggle-text');
                
                if (mode === 'login') {
                    modalTitle.textContent = 'Sign In';
                    loginForm.classList.remove('hidden');
                    registerForm.classList.add('hidden');
                    toggleText.textContent = "Don't have an account? Sign up";
                } else {
                    modalTitle.textContent = 'Create Account';
                    loginForm.classList.add('hidden');
                    registerForm.classList.remove('hidden');
                    toggleText.textContent = "Already have an account? Sign in";
                }
                
                authModal.classList.remove('hidden');
                clearAuthError();
            }
            
            function hideAuthModal() {
                const authModal = document.getElementById('auth-modal');
                const loginForm = document.getElementById('login-form');
                const registerForm = document.getElementById('register-form');
                
                authModal.classList.add('hidden');
                loginForm.reset();
                registerForm.reset();
                clearAuthError();
            }
            
            function setupAuthModal() {
                // Only setup modal if not in iframe mode
                if (window.self !== window.top) {
                    return;
                }
                
                const closeModalBtn = document.getElementById('close-modal');
                const toggleAuthBtn = document.getElementById('toggle-auth');
                const loginForm = document.getElementById('login-form');
                const registerForm = document.getElementById('register-form');
                const authModal = document.getElementById('auth-modal');
                
                if (closeModalBtn) {
                    closeModalBtn.addEventListener('click', hideAuthModal);
                }
                
                if (toggleAuthBtn) {
                    toggleAuthBtn.addEventListener('click', () => {
                        const isLoginVisible = !loginForm.classList.contains('hidden');
                        showAuthModal(isLoginVisible ? 'register' : 'login');
                    });
                }
                
                if (loginForm) {
                    loginForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        
                        const username = document.getElementById('login-username').value;
                        const password = document.getElementById('login-password').value;
                        
                        if (!username || !password) {
                            showAuthError('Please fill in all fields');
                            return;
                        }
                        
                        setLoginLoading(true);
                        clearAuthError();
                        
                        try {
                            console.log('Attempting login with credentials:', { username, password: '***' });
                            await window.authManager.login({
                                username: username,
                                password: password
                            });
                            console.log('Login successful');
                            hideAuthModal();
                        } catch (error) {
                            console.error('Login error:', error);
                            let errorMessage = 'Login failed. Please try again.';
                            
                            if (error.message && error.message !== '[object Object]') {
                                errorMessage = error.message;
                            } else if (error.detail) {
                                errorMessage = error.detail;
                            }
                            
                            showAuthError(errorMessage);
                        } finally {
                            setLoginLoading(false);
                        }
                    });
                }
                
                if (registerForm) {
                    registerForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        
                        const username = document.getElementById('register-username').value;
                        const email = document.getElementById('register-email').value;
                        const password = document.getElementById('register-password').value;
                        
                        if (!username || !email || !password) {
                            showAuthError('Please fill in all fields');
                            return;
                        }
                        
                        setRegisterLoading(true);
                        clearAuthError();
                        
                        try {
                            await window.authManager.register({
                                username: username,
                                email: email,
                                password: password
                            });
                            hideAuthModal();
                        } catch (error) {
                            console.error('Registration error:', error);
                            let errorMessage = 'Registration failed. Please try again.';
                            
                            if (error.message && error.message !== '[object Object]') {
                                errorMessage = error.message;
                            } else if (error.detail) {
                                errorMessage = error.detail;
                            }
                            
                            showAuthError(errorMessage);
                        } finally {
                            setRegisterLoading(false);
                        }
                    });
                }
                
                // Close modal on backdrop click
                if (authModal) {
                    authModal.addEventListener('click', (e) => {
                        if (e.target === authModal) hideAuthModal();
                    });
                }
            }
            
            function setLoginLoading(loading) {
                const loginLoading = document.getElementById('login-loading');
                const loginText = document.getElementById('login-text');
                const loginButton = document.querySelector('#login-form button');
                
                if (loginLoading) loginLoading.classList.toggle('hidden', !loading);
                if (loginText) loginText.classList.toggle('hidden', loading);
                if (loginButton) loginButton.disabled = loading;
            }
            
            function setRegisterLoading(loading) {
                const registerLoading = document.getElementById('register-loading');
                const registerText = document.getElementById('register-text');
                const registerButton = document.querySelector('#register-form button');
                
                if (registerLoading) registerLoading.classList.toggle('hidden', !loading);
                if (registerText) registerText.classList.toggle('hidden', loading);
                if (registerButton) registerButton.disabled = loading;
            }
            
            function showAuthError(message) {
                const errorDiv = document.getElementById('auth-error');
                const errorText = document.getElementById('error-text');
                
                if (errorDiv && errorText) {
                    errorText.textContent = message;
                    errorDiv.classList.remove('hidden');
                } else {
                    // Fallback: show in console and alert
                    console.error('Auth error:', message);
                    alert('Authentication Error: ' + message);
                }
            }
            
            function clearAuthError() {
                const errorDiv = document.getElementById('auth-error');
                if (errorDiv) {
                    errorDiv.classList.add('hidden');
                }
            }
            
            // Start initialization
            initializeAuth();
            
            // Setup auth modal after initialization
            setTimeout(() => {
                setupAuthModal();
            }, 100);
        });
    </script>
    
    <!-- Authentication Modal (only shown in direct mode) -->
    <div id="auth-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modal-title" class="text-2xl font-bold text-gray-900">Sign In</h2>
                <button id="close-modal" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Login Form -->
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Username or Email</label>
                    <input type="text" id="login-username" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="login-password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                </div>
                <button type="submit" class="w-full bg-primary text-white py-2 px-4 rounded-md hover:bg-primary-600 transition duration-200">
                    <span id="login-loading" class="hidden">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Signing in...
                    </span>
                    <span id="login-text">Sign In</span>
                </button>
            </form>

            <!-- Register Form -->
            <form id="register-form" class="hidden space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                    <input type="text" id="register-username" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="register-email" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="register-password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" required>
                    <p class="text-xs text-gray-500 mt-1">At least 8 characters with letters and numbers</p>
                </div>
                <button type="submit" class="w-full bg-primary text-white py-2 px-4 rounded-md hover:bg-primary-600 transition duration-200">
                    <span id="register-loading" class="hidden">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Creating account...
                    </span>
                    <span id="register-text">Create Account</span>
                </button>
            </form>

            <!-- Form Toggle -->
            <div class="mt-6 text-center">
                <button id="toggle-auth" class="text-primary hover:text-primary-600 font-medium">
                    <span id="toggle-text">Don't have an account? Sign up</span>
                </button>
            </div>

            <!-- Error Message -->
            <div id="auth-error" class="hidden mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded">
                <p id="error-text"></p>
            </div>
        </div>
    </div>
</body>
</html>