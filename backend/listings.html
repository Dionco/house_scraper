<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funda Finder | Advanced Search</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': {
                            'DEFAULT': '#F97316', // Funda Orange
                            '600': '#EA580C',
                        },
                        'secondary': '#1E293B',
                        'light': '#F8FAFC',
                        'gray': {
                            '100': '#F1F5F9',
                            '200': '#E2E8F0',
                            '300': '#CBD5E1',
                            '400': '#94A3B8',
                            '500': '#64748B',
                            '700': '#334155',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }
        .sticky-sidebar { position: sticky; top: 2rem; max-height: calc(100vh - 4rem); overflow-y: auto; }
        /* Custom scrollbar for the sidebar */
        .sticky-sidebar::-webkit-scrollbar { width: 6px; }
        .sticky-sidebar::-webkit-scrollbar-track { background: transparent; }
        .sticky-sidebar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 3px; }
        .sticky-sidebar::-webkit-scrollbar-thumb:hover { background: #cbd5e1; }
        /* Custom styles for details/summary accordion */
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        
        /* Custom styles for wizard form elements */
        .form-checkbox {
            width: 1rem;
            height: 1rem;
            color: #F97316;
            border: 1px solid #D1D5DB;
            border-radius: 0.25rem;
        }
        .form-checkbox:focus {
            outline: 2px solid #F97316;
            outline-offset: 2px;
        }
        .wizard-step {
            min-height: 400px;
            opacity: 0;
            transform: translateX(20px);
            transition: all 0.3s ease-in-out;
        }
        .wizard-step:not(.hidden) {
            opacity: 1;
            transform: translateX(0);
        }
        .location-option {
            transition: all 0.2s ease-in-out;
        }
        .location-option:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .location-radio {
            transition: all 0.2s ease-in-out;
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        details > summary .chevron { transition: transform 0.2s ease-in-out; }
        details[open] > summary .chevron { transform: rotate(90deg); }
        /* Custom checkbox styles */
        .form-checkbox { appearance: none; -webkit-appearance: none; height: 1.25rem; width: 1.25rem; border: 1px solid #cbd5e1; border-radius: 0.25rem; background-color: #fff; transition: all 0.2s; cursor: pointer; }
        .form-checkbox:checked { background-color: #F97316; border-color: #F97316; background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e"); background-size: 100% 100%; background-position: center; background-repeat: no-repeat; }
    </style>
</head>
<body class="font-sans bg-light">
    <!-- User Authentication Header -->
    <div class="bg-white border-b border-gray-200 shadow-sm">
        <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                    <h1 class="text-xl font-bold text-secondary">Funda Finder</h1>
                </div>
                
                <!-- Authentication Status -->
                <div class="flex items-center gap-4">
                    <!-- Not authenticated -->
                    <div id="auth-not-logged-in" class="flex items-center gap-2">
                        <button id="login-btn" class="text-sm font-medium text-gray-700 hover:text-primary transition-colors">
                            Login
                        </button>
                        <span class="text-gray-300">|</span>
                        <button id="register-btn" class="text-sm font-medium text-primary hover:text-primary-600 transition-colors">
                            Register
                        </button>
                    </div>
                    
                    <!-- Authenticated -->
                    <div id="auth-logged-in" class="flex items-center gap-3 hidden">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center">
                                <span class="text-white font-medium text-sm" id="user-initial">U</span>
                            </div>
                            <span class="text-sm font-medium text-gray-700" id="user-name">User</span>
                        </div>
                        <div class="relative">
                            <button id="user-menu-btn" class="flex items-center gap-1 text-sm text-gray-500 hover:text-gray-700 transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="user-menu" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg ring-1 ring-black ring-opacity-5 z-10 hidden">
                                <div class="py-1">
                                    <a href="#" id="user-profile-link" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Profile Settings</a>
                                    <a href="#" id="logout-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 py-8">

            <aside class="lg:col-span-3">
                <div class="sticky-sidebar pr-4">
                    <!-- Authentication Notice -->
                    <div id="auth-notice" class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg hidden">
                        <div class="flex items-center gap-2 text-blue-800">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="text-sm font-medium">Login to save and manage your search profiles</span>
                        </div>
                    </div>

                    <div class="mb-6 p-4 bg-white rounded-lg border shadow-sm">
                        <div class="flex items-center justify-between mb-3">
                            <h2 class="text-lg font-bold text-secondary">Search Profiles</h2>
                            <button id="toggle-profile-actions" class="p-1 rounded-md hover:bg-gray-100 transition-colors hidden">
                                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zM12 13a1 1 0 110-2 1 1 0 010 2zM12 20a1 1 0 110-2 1 1 0 010 2z"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Profile Selection -->
                        <div class="mb-3">
                            <div class="relative">
                                <select id="profile-select" class="block appearance-none w-full bg-gray-50 border border-gray-200 text-gray-700 py-2.5 px-3 pr-8 rounded-lg text-sm focus:outline-none focus:bg-white focus:border-primary transition duration-200">
                                    <option value="">Select a saved profile...</option>
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 6.757 7.586 5.343 9z"/></svg>
                                </div>
                            </div>
                        </div>

                        <!-- Active Profile Info -->
                        <div id="active-profile-info" class="hidden mb-3 p-3 bg-primary/5 border border-primary/20 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="text-sm font-medium text-primary" id="active-profile-name">Profile Name</div>
                                    <div class="text-xs text-gray-500" id="active-profile-emails">No emails set</div>
                                    <div class="text-xs text-green-600 font-medium mt-1" id="active-profile-new-today">
                                        <span class="inline-flex items-center gap-1">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            <span id="new-today-count">0</span> new today
                                        </span>
                                    </div>
                                </div>
                                <div class="flex gap-1">
                                    <button id="edit-profile-btn" class="p-1.5 rounded-md hover:bg-primary/10 transition-colors" title="Edit profile">
                                        <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                        </svg>
                                    </button>
                                    <button id="delete-profile-btn" class="p-1.5 rounded-md hover:bg-red-50 transition-colors" title="Delete profile">
                                        <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Edit Search Profile Button -->
                        <div id="edit-search-profile-container" class="hidden mb-3">
                            <button id="edit-search-profile-btn" class="w-full flex items-center justify-center gap-2 px-3 py-2 bg-white border border-primary text-primary text-sm font-medium rounded-lg hover:bg-primary/5 transition duration-200">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                                Edit Search Profile
                            </button>
                        </div>

                        <!-- Save new profile action -->
                        <div class="mt-3 pt-3 border-t border-gray-100">
                        <div class="mt-3 pt-3 border-t border-gray-100">
                            <button id="create-new-profile-btn" class="w-full flex items-center justify-center gap-2 px-3 py-2 bg-primary text-white text-sm font-medium rounded-lg hover:bg-primary-600 transition duration-200">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                Create New Search Profile
                            </button>
                        </div>
                    </div>

                    <form id="scrape-filter-form" class="space-y-1">
                        <!-- Scrape for Updates Button (moved to top, cleaner style) -->
                        <div class="mb-4">
                            <button type="submit" id="scrape-updates-btn" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-primary text-white font-semibold rounded-lg shadow hover:bg-primary-600 focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                                <span>Scrape for Updates</span>
                            </button>
                        </div>
                        <div class="p-3">
                             <label for="keyword" class="text-sm font-medium text-gray-700">Keyword Search</label>
                             <input type="text" id="keyword" name="keyword" class="mt-1 w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition" placeholder="e.g. warmtepomp, airco">
                        </div>
                        <div class="p-3 pt-0">
                            <label for="city" class="text-sm font-medium text-gray-700">City</label>
                            <input type="text" id="city" name="city" class="mt-1 w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition" placeholder="e.g. Amsterdam, Rotterdam">
                        </div>

                        <details class="group py-2" open>
                            <summary class="flex justify-between items-center cursor-pointer text-lg font-semibold text-secondary">
                                Price & Type
                                <svg class="chevron h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                            </summary>
                            <div class="pt-4 space-y-4">
                                <div>
                                    <label class="text-sm font-medium text-gray-700">Price Range (€)</label>
                                    <div class="flex items-center gap-2 mt-1">
                                        <input type="number" name="min_price" class="w-full px-3 py-2 border border-gray-200 rounded-lg" placeholder="From" value="3000">
                                        <span class="text-gray-400">-</span>
                                        <input type="number" name="max_price" class="w-full px-3 py-2 border border-gray-200 rounded-lg" placeholder="To" value="5000">
                                    </div>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-700">Property Type</label>
                                    <div class="mt-2 space-y-2">
                                        <label class="flex items-center gap-2 text-sm"><input type="checkbox" name="property_type" value="woonhuis" class="form-checkbox"> Woonhuis</label>
                                        <label class="flex items-center gap-2 text-sm"><input type="checkbox" name="property_type" value="appartement" class="form-checkbox"> Appartement</label>
                                        <label class="flex items-center gap-2 text-sm"><input type="checkbox" name="property_type" value="parkeergelegenheid" class="form-checkbox"> Parkeergelegenheid</label>
                                    </div>
                                </div>
                            </div>
                        </details>

                        <details class="group py-2">
                            <summary class="flex justify-between items-center cursor-pointer text-lg font-semibold text-secondary">
                                Area & Layout
                                <svg class="chevron h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                            </summary>
                            <div class="pt-4 space-y-4">
                                <div>
                                    <label class="text-sm font-medium text-gray-700">Living Area (m²)</label>
                                    <div class="flex items-center gap-2 mt-1">
                                        <input type="number" name="min_area" class="w-full px-3 py-2 border border-gray-200 rounded-lg" placeholder="From">
                                        <span class="text-gray-400">-</span>
                                        <input type="number" name="max_area" class="w-full px-3 py-2 border border-gray-200 rounded-lg" placeholder="To">
                                    </div>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-700">Rooms</label>
                                    <div class="flex items-center gap-2 mt-1">
                                        <input type="number" name="min_rooms" class="w-full px-3 py-2 border border-gray-200 rounded-lg" placeholder="From">
                                        <span class="text-gray-400">-</span>
                                        <input type="number" name="max_rooms" class="w-full px-3 py-2 border border-gray-200 rounded-lg" placeholder="To">
                                    </div>
                                </div>
                                 <div>
                                    <label class="text-sm font-medium text-gray-700">Bedrooms</label>
                                    <div class="flex items-center gap-2 mt-1">
                                        <input type="number" name="min_bedrooms" class="w-full px-3 py-2 border border-gray-200 rounded-lg" placeholder="From">
                                        <span class="text-gray-400">-</span>
                                        <input type="number" name="max_bedrooms" class="w-full px-3 py-2 border border-gray-200 rounded-lg" placeholder="To">
                                    </div>
                                </div>
                            </div>
                        </details>
                         
                        <details class="group py-2">
                            <summary class="flex justify-between items-center cursor-pointer text-lg font-semibold text-secondary">
                                Availability & Conditions
                                <svg class="chevron h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                            </summary>
                            <div class="pt-4 space-y-4">
                                <div>
                                    <label for="listed_since" class="text-sm font-medium text-gray-700">Listed Since</label>
                                    <select id="listed_since" name="listed_since" class="mt-1 w-full px-3 py-2 border border-gray-200 rounded-lg">
                                        <option value="">Any</option>
                                        <option value="1">Today</option>
                                        <option value="3">Last 3 days</option>
                                        <option value="5">Last 5 days</option>
                                        <option value="10">Last 10 days</option>
                                        <option value="30">Last 30 days</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-700">Rental Conditions</label>
                                    <div class="mt-2 space-y-2">
                                        <label class="flex items-center gap-2 text-sm"><input type="checkbox" name="rental_condition" value="furnished" class="form-checkbox"> Furnished</label>
                                        <label class="flex items-center gap-2 text-sm"><input type="checkbox" name="rental_condition" value="partially_furnished" class="form-checkbox"> Partially Furnished</label>
                                    </div>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-700">Rental Agreement</label>
                                    <div class="mt-2 space-y-2">
                                        <label class="flex items-center gap-2 text-sm"><input type="checkbox" name="rental_agreement" value="indefinite" class="form-checkbox"> Indefinite</label>
                                        <label class="flex items-center gap-2 text-sm"><input type="checkbox" name="rental_agreement" value="temporary" class="form-checkbox"> Temporary</label>
                                    </div>
                                </div>
                            </div>
                        </details>

                        <details class="group py-2">
                            <summary class="flex justify-between items-center cursor-pointer text-lg font-semibold text-secondary">
                                Features
                                <svg class="chevron h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                            </summary>
                             <div class="pt-4 space-y-4">
                                <div>
                                    <label for="energy_label" class="text-sm font-medium text-gray-700">Min. Energy Label</label>
                                    <select id="energy_label" name="energy_label" class="mt-1 w-full px-3 py-2 border border-gray-200 rounded-lg">
                                         <option value="">Any</option>
                                         <option value="A_PLUS_PLUS_PLUS_PLUS_PLUS">A+++++</option>
                                         <option value="A_PLUS_PLUS_PLUS_PLUS">A++++</option>
                                         <option value="A_PLUS_PLUS_PLUS">A+++</option>
                                         <option value="A_PLUS_PLUS">A++</option>
                                         <option value="A_PLUS">A+</option>
                                         <option value="A">A</option>
                                         <option value="B">B</option>
                                         <option value="C">C</option>
                                         <option value="D">D</option>
                                         <option value="E">E</option>
                                         <option value="F">F</option>
                                         <option value="G">G</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-700">Outdoor Space</label>
                                    <div class="mt-2 space-y-2">
                                        <label class="flex items-center gap-2 text-sm"><input type="checkbox" name="outdoor_space" value="garden" class="form-checkbox"> Garden</label>
                                        <label class="flex items-center gap-2 text-sm"><input type="checkbox" name="outdoor_space" value="balcony" class="form-checkbox"> Balcony</label>
                                        <label class="flex items-center gap-2 text-sm"><input type="checkbox" name="outdoor_space" value="roof_terrace" class="form-checkbox"> Roof Terrace</label>
                                    </div>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-700">Parking</label>
                                    <div class="mt-2 space-y-2">
                                        <label class="flex items-center gap-2 text-sm"><input type="checkbox" name="parking" value="private" class="form-checkbox"> Private Parking</label>
                                        <label class="flex items-center gap-2 text-sm"><input type="checkbox" name="parking" value="garage" class="form-checkbox"> Garage</label>
                                    </div>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-700">Accessibility</label>
                                    <div class="mt-2 space-y-2">
                                        <label class="flex items-center gap-2 text-sm"><input type="checkbox" name="accessibility" value="elevator" class="form-checkbox"> Elevator</label>
                                        <label class="flex items-center gap-2 text-sm"><input type="checkbox" name="accessibility" value="single_floor" class="form-checkbox"> Single Floor</label>
                                    </div>
                                </div>
                            </div>
                        </details>
                    </form>
                </div>
            </aside>

            <main class="lg:col-span-9">
                 <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
                    <div class="bg-white border border-gray-200 rounded-xl p-4 text-center">
                        <span class="text-2xl font-bold block text-secondary" id="total-listings">-</span>
                        <span class="text-sm text-gray-500">Total Listings</span>
                    </div>
                    <div class="bg-white border border-gray-200 rounded-xl p-4 text-center">
                        <span class="text-2xl font-bold block text-secondary" id="avg-price">-</span>
                        <span class="text-sm text-gray-500">Avg Price</span>
                    </div>
                    <div class="bg-white border border-gray-200 rounded-xl p-4 text-center">
                        <span class="text-2xl font-bold block text-secondary" id="new-today">-</span>
                        <span class="text-sm text-gray-500">New Today</span>
                    </div>
                </div>
                <div class="text-center py-24" id="loading-live" style="display: block;">
                    <div class="w-10 h-10 border-4 border-gray-200 border-t-primary rounded-full spinner mx-auto"></div>
                    <p class="mt-4 text-gray-500">Loading initial listings...</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6" id="listings-live" style="display: none;"></div>
            </main>
        </div>
    </div>

    <script>
        // --- NOTIFICATION SYSTEM ---
        function showNotification(message, type = 'info', duration = 5000) {
            const notificationContainer = document.getElementById('notification-container');
            const notification = document.createElement('div');
            
            const iconMap = {
                'success': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>',
                'error': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>',
                'warning': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path></svg>',
                'info': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
            };
            
            const colorMap = {
                'success': 'bg-green-50 border-green-200 text-green-800',
                'error': 'bg-red-50 border-red-200 text-red-800',
                'warning': 'bg-yellow-50 border-yellow-200 text-yellow-800',
                'info': 'bg-blue-50 border-blue-200 text-blue-800'
            };
            
            notification.className = `flex items-center gap-3 p-4 rounded-lg border shadow-lg ${colorMap[type]} transform transition-all duration-300 translate-x-full opacity-0`;
            notification.innerHTML = `
                <div class="flex-shrink-0">${iconMap[type]}</div>
                <div class="flex-1 text-sm font-medium">${message}</div>
                <button onclick="this.parentElement.remove()" class="flex-shrink-0 p-1 rounded-full hover:bg-black/10 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            `;
            
            notificationContainer.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full', 'opacity-0');
            }, 10);
            
            // Auto remove
            if (duration > 0) {
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.classList.add('translate-x-full', 'opacity-0');
                        setTimeout(() => notification.remove(), 300);
                    }
                }, duration);
            }
        }
        
        function showConfirmation(title, message, onConfirm, confirmButtonText = 'Confirm', confirmButtonClass = 'bg-red-500 hover:bg-red-600') {
            const modal = document.getElementById('confirmation-modal');
            const titleEl = document.getElementById('confirmation-title');
            const messageEl = document.getElementById('confirmation-message');
            const confirmBtn = document.getElementById('confirmation-confirm');
            const cancelBtn = document.getElementById('confirmation-cancel');
            
            titleEl.textContent = title;
            messageEl.textContent = message;
            confirmBtn.textContent = confirmButtonText;
            confirmBtn.className = `px-4 py-2 rounded text-white ${confirmButtonClass}`;
            
            modal.classList.remove('hidden');
            
            const handleConfirm = () => {
                modal.classList.add('hidden');
                onConfirm();
                confirmBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
            };
            
            const handleCancel = () => {
                modal.classList.add('hidden');
                confirmBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
            };
            
            confirmBtn.addEventListener('click', handleConfirm);
            cancelBtn.addEventListener('click', handleCancel);
        }

        // --- GLOBAL VARIABLES ---
        let currentProfileId = null;
        let profiles = {}; // Store profiles fetched from API
        let isProfileActionsExpanded = false;

        // --- GLOBAL FUNCTIONS ---
        
        // Example of how to call saveListing (assuming it sends to a backend to save favorited listings)
        function saveListing(fundaUrl) {
            console.log(`Saving listing: ${fundaUrl}`);
            // In a real application, you'd send this to your backend
            // fetch('/api/save-listing', {
            //     method: 'POST',
            //     headers: { 'Content-Type': 'application/json' },
            //     body: JSON.stringify({ url: fundaUrl, profileId: currentProfileId }) // Optionally associate with profile
            // }).then(response => {
            //     if (response.ok) showNotification('Listing saved!', 'success');
            //     else showNotification('Failed to save listing.', 'error');
            // }).catch(error => console.error('Error saving listing:', error));
            showNotification('Listing save functionality (backend) not implemented in this example.', 'info');
        }

        // --- MAPPING & RENDERING (No changes from previous version) ---
        function mapLegacyListing(listing) {
            // Prefer address.street_name, and split house number if needed
            let full_street = listing['address.street_name'] || listing.street_name || listing.address || '';
            let street_name = full_street;
            let house_number = listing['address.house_number'] || listing.house_number || '';
            // If house_number is missing/null/empty, try to extract from street_name
            if (full_street && (!house_number || house_number === null)) {
                const match = full_street.match(/^(.*?)(\s+\d.*)$/);
                if (match) {
                    street_name = match[1].trim();
                    house_number = match[2].trim();
                } else {
                    // If no match, just use the full street as street_name, blank house_number
                    street_name = full_street;
                    house_number = '';
                }
            }
            // If house_number is still empty, just show the full street as street_name
            if (!house_number) {
                street_name = full_street;
            }
            const postal_code = listing['address.postal_code'] || listing.postal_code || listing.area_code || '';
            const city = listing['address.city'] || listing.city || '';
            const rent_price = listing['price.rent_price'] || listing.rent_price || listing.price;
            const rent_price_type = listing['price.rent_price_type'] || listing.rent_price_type || 'per month';
            const floor_area = listing.floor_area || listing['floor_area'] || listing.area;
            const number_of_bedrooms = listing.number_of_bedrooms || listing['number_of_bedrooms'] || listing.bedrooms;
            const energy_label = listing.energy_label || listing['energy_label'];
            const publish_date = listing.publish_date || listing['publish_date'] || listing.listed_since;
            const funda_url = listing.funda_url || listing['object_detail_page_relative_url'];
            const image_url = listing.image_url;
            const status = listing.status || null;
            // If we have at least a street_name, show it, else fallback to Unknown Address
            return {
                ...listing,
                street_name: street_name || 'Unknown Address',
                house_number,
                postal_code,
                city,
                rent_price,
                rent_price_type,
                floor_area,
                number_of_bedrooms,
                energy_label,
                publish_date,
                funda_url,
                image_url,
                status
            };
        }

        function renderListingCard(listing) {
            const price = listing.rent_price ? `€${listing.rent_price.toLocaleString('nl-NL')}` : 'Price on request';
            const placeholderImage = `https://via.placeholder.com/400x300.png?text=No+Image+Available`;
            return `
                <div class="bg-white rounded-xl border border-gray-200 overflow-hidden group hover:shadow-xl hover:border-primary/50 transition-all duration-300 flex flex-col">
                    <div class="relative">
                        <img src="${listing.image_url || placeholderImage}" alt="Photo of ${listing.street_name || 'property'}" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='${placeholderImage}';">
                        ${listing.is_new ? `<div class=\"absolute top-3 left-3 bg-accent text-white px-2.5 py-1 rounded-full text-xs font-bold shadow-lg\" style=\"background-color: #10b981;\">✨ NEW</div>` : ''}
                        ${listing.energy_label ? `<div class=\"absolute top-3 right-3 bg-white/90 backdrop-blur-sm text-secondary px-2 py-1 rounded-full text-xs font-bold shadow-md\">⚡ ${listing.energy_label}</div>` : ''}
                    </div>
                    <div class="p-5 flex flex-col flex-grow">
                         <h3 class="font-bold text-lg text-secondary group-hover:text-primary transition-colors pr-4">${listing.street_name || 'Unknown Address'} ${listing.house_number || ''}</h3>
                        <p class="text-sm text-gray-500 mt-1">${listing.postal_code || ''} ${listing.city || ''}</p>
                        <div class="my-5">
                            <span class="text-2xl font-extrabold text-secondary block leading-none">${price}</span>
                            <span class="text-sm text-gray-500">${listing.rent_price_type || 'per month'}</span>
                        </div>
                            <div class="grid grid-cols-2 gap-4 text-sm mb-6">
                            <div><span class="text-xs font-semibold uppercase tracking-wide text-gray-400">Area </span><span class="font-semibold text-secondary">${listing.floor_area || '-'} m²</span></div>
                            <div><span class="text-xs font-semibold uppercase tracking-wide text-gray-400">Bedrooms </span><span class="font-semibold text-secondary">${listing.number_of_bedrooms || '-'}</span></div>
                        </div>
                        <div class="flex gap-2 flex-col sm:flex-row mt-auto pt-4 border-t border-gray-100">
                            <a href="${listing.funda_url || '#'}" target="_blank" class="flex-1 inline-flex items-center justify-center gap-2 px-4 py-2 bg-primary text-white font-semibold text-sm rounded-lg hover:bg-primary-600">View on Funda</a>
                            <button class="inline-flex items-center justify-center px-4 py-2 bg-gray-100 text-gray-700 font-semibold text-sm rounded-lg hover:bg-gray-200" onclick="saveListing('${listing.funda_url || ''}')">❤️</button>
                        </div>
                    </div>
                </div>`;
        }
        // --- EVENT LISTENERS ---

        document.addEventListener('DOMContentLoaded', () => {
            console.log('=== DOM Content Loaded ===');
            
            // --- DOM ELEMENT REFERENCES ---
            console.log('Initializing DOM elements...');
            
            // Main form and layout elements
            const form = document.getElementById('scrape-filter-form');
            const loadingSpinner = document.getElementById('loading-live');
            const listingsContainer = document.getElementById('listings-live');
            const profileSelect = document.getElementById('profile-select');
            
            console.log('DOM elements initialized:', {
                form: !!form,
                loadingSpinner: !!loadingSpinner,
                listingsContainer: !!listingsContainer,
                profileSelect: !!profileSelect
            });
            
            // Active profile info elements
            const activeProfileInfo = document.getElementById('active-profile-info');
            const activeProfileNameSpan = document.getElementById('active-profile-name');
            const activeProfileEmails = document.getElementById('active-profile-emails');
            
            // Scrape updates button
            const scrapeUpdatesBtn = document.getElementById('scrape-updates-btn');
            
            // Profile management buttons
            const editProfileBtn = document.getElementById('edit-profile-btn');
            const deleteProfileBtn = document.getElementById('delete-profile-btn');
            
            // Profile wizard elements
            const profileWizardModal = document.getElementById('profile-wizard-modal');
            const createNewProfileBtn = document.getElementById('create-new-profile-btn');
            const wizardCloseBtn = document.getElementById('wizard-close');
            const wizardPrevBtn = document.getElementById('wizard-prev');
            const wizardNextBtn = document.getElementById('wizard-next');
            const wizardSkipBtn = document.getElementById('wizard-skip');
            const wizardCreateBtn = document.getElementById('wizard-create');
            const wizardCurrentStepSpan = document.getElementById('wizard-current-step');
            const wizardProgress = document.getElementById('wizard-progress');
            
            // Edit search profile modal elements
            const editSearchProfileModal = document.getElementById('edit-search-profile-modal');
            const editSearchProfileBtn = document.getElementById('edit-search-profile-btn');
            const editSearchProfileContainer = document.getElementById('edit-search-profile-container');
            const editProfileClose = document.getElementById('edit-profile-close');
            const editProfileCancel = document.getElementById('edit-profile-cancel');
            const editProfileSave = document.getElementById('edit-profile-save');
            const editProfileDeleteBtn = document.getElementById('edit-profile-delete-btn');
            const editProfileName = document.getElementById('edit-profile-name');
            const editProfileEmails = document.getElementById('edit-profile-emails');
            const editUpdateEmailsBtn = document.getElementById('edit-update-emails-btn');
            const editScraperStatus = document.getElementById('edit-scraper-status');
            const editScrapeInterval = document.getElementById('edit-scrape-interval');
            const editUpdateIntervalBtn = document.getElementById('edit-update-interval-btn');
            const editLastScraped = document.getElementById('edit-last-scraped');
            
            // --- UTILITY FUNCTIONS (moved inside DOMContentLoaded) ---
            function renderListings(listings, emptyMessage) {
                console.log('=== renderListings() called ===');
                console.log('Listings count:', listings.length);
                
                // Always map listings to ensure correct structure
                const mappedListings = listings.map(mapLegacyListing);
                if (typeof debugListingKeys === 'function') {
                    debugListingKeys(mappedListings);
                }
                if (mappedListings.length === 0) {
                    listingsContainer.innerHTML = emptyMessage;
                    // Update stats for empty state
                    updateStats([]);
                    return;
                }
                // Check if any listing is new
                const hasNew = mappedListings.some(l => l.is_new);
                let banner = '';
                if (hasNew) {
                    banner = `<div id="new-listings-banner" class="col-span-full mb-4 p-4 rounded-lg bg-green-100 text-green-900 flex items-center justify-between shadow">
                        <span>✨ <b>New listings have been added!</b> Check out the latest properties below.</span>
                        <button onclick="this.parentElement.style.display='none'" class="ml-4 px-3 py-1 rounded bg-green-200 hover:bg-green-300 text-green-900 font-semibold text-xs">Dismiss</button>
                    </div>`;
                }
                console.log('Setting innerHTML with', mappedListings.length, 'listings');
                listingsContainer.innerHTML = banner + mappedListings.map(renderListingCard).join('');
                // Update stats for this profile
                updateStats(mappedListings);
                console.log('renderListings completed');
            }
            
            function getEmptyStateMessage(isFilter) {
                const icon = isFilter 
                    ? `<svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>`
                    : `<svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>`;
                const title = isFilter ? "No Listings Found" : "No Initial Listings";
                const text = isFilter ? "Try adjusting your filters for a wider search." : "Your local listings file seems to be empty. Use the filters to start a search.";
                return `<div class="md:col-span-2 xl:col-span-3 text-center py-24 bg-white rounded-xl border border-gray-200">${icon}<h3 class="mt-4 text-lg font-medium text-secondary">${title}</h3><p class="mt-1 text-sm text-gray-500">${text}</p></div>`;
            }

            function updateStats(listings) {
                document.getElementById('total-listings').textContent = listings.length;
                const pricedListings = listings.filter(l => typeof l.rent_price === 'number');
                document.getElementById('avg-price').textContent = pricedListings.length > 0 ? `€${Math.round(pricedListings.reduce((sum, l) => sum + l.rent_price, 0) / pricedListings.length).toLocaleString('nl-NL')}` : 'N/A';
                // document.getElementById('new-today').textContent = listings.filter(l => l.publish_date && new Date(l.publish_date).toDateString() === new Date().toDateString()).length;
                document.getElementById('new-today').textContent = listings.filter(l => l.is_new).length;
            }
            
            // --- API & DATA FETCHING FUNCTIONS ---
            async function fetchListings(profileId, isFilter) {
                try {
                    console.log('=== fetchListings() called ===');
                    console.log('Profile ID:', profileId, 'isFilter:', isFilter);
                    console.log('listingsContainer:', !!listingsContainer);
                    console.log('loadingSpinner:', !!loadingSpinner);
                    
                    listingsContainer.style.display = 'none';
                    loadingSpinner.style.display = 'block';
                    let url = '/api/listings';
                    if (profileId) {
                        url += `?profile_id=${encodeURIComponent(profileId)}`;
                    }
                    console.log('Fetching from URL:', url);
                    
                    // Use authenticated request if authManager is available and user is logged in
                    const response = (typeof authManager !== 'undefined' && authManager.isAuthenticated()) 
                        ? await authManager.apiRequest(url)
                        : await fetch(url);
                    
                    console.log('Response status:', response.status);
                    if (!response.ok) throw new Error(`Server error: ${response.statusText}`);
                    const data = await response.json();
                    console.log('Data received:', data);
                    console.log('Listings count:', data.listings ? data.listings.length : 'undefined');
                    renderListings(data.listings, getEmptyStateMessage(isFilter));
                } catch (error) {
                    console.error('Error fetching listings:', error);
                    listingsContainer.innerHTML = `<div class="md:col-span-2 xl:col-span-3 text-center py-24 bg-red-50 rounded-xl border border-red-200 text-red-700">
                        <p class="font-semibold">Error loading listings.</p>
                        <p class="text-sm">Please try again later. Details: ${error.message}</p>
                    </div>`;
                    updateStats([]);
                } finally {
                    loadingSpinner.style.display = 'none';
                    listingsContainer.style.display = 'grid';
                }
            }
            
            /**
             * Fetches all saved profiles from the backend.
             */
            async function fetchProfiles() {
                try {
                    console.log('=== fetchProfiles() called ===');
                    
                    // Check if authManager is available and user is authenticated
                    if (typeof authManager !== 'undefined' && authManager.isAuthenticated()) {
                        console.log('User authenticated, fetching user profiles');
                        const response = await authManager.apiRequest('/api/profiles');
                        console.log('fetchProfiles response status:', response.status);
                        if (!response.ok) throw new Error(`Failed to fetch profiles: ${response.statusText}`);
                        const data = await response.json();
                        console.log('fetchProfiles data received:', data.length, 'profiles');
                        profiles = {}; // Clear existing profiles
                        data.forEach(profile => {
                            profiles[profile.id] = profile; // Store by ID for easy lookup
                        });
                    } else {
                        console.log('User not authenticated or authManager not available, clearing profiles');
                        profiles = {};
                    }
                    
                    console.log('Calling renderProfileSelect()...');
                    renderProfileSelect();
                    console.log('fetchProfiles completed successfully');
                } catch (error) {
                    console.error('Error fetching profiles:', error);
                    if (error.message.includes('401')) {
                        // Authentication error - clear profiles
                        profiles = {};
                        renderProfileSelect();
                        showNotification('Please log in to access your search profiles.', 'warning');
                    } else {
                        showNotification('Could not load search profiles. Please try refreshing the page.', 'error');
                    }
                }
            }

            /**
             * Renders the profiles into the dropdown select element.
             */
            function renderProfileSelect() {
                console.log('=== renderProfileSelect() called ===');
                profileSelect.innerHTML = '<option value="">Select a saved profile...</option>';
                const sortedProfileNames = Object.values(profiles).sort((a, b) => a.name.localeCompare(b.name));
                console.log('Rendering profiles:', sortedProfileNames.length);
                sortedProfileNames.forEach(profile => {
                    const option = document.createElement('option');
                    option.value = profile.id;
                    option.textContent = profile.name;
                    profileSelect.appendChild(option);
                });

                // Set the dropdown to the currently active profile and update the view
                profileSelect.value = currentProfileId;
                updateProfileViewState(currentProfileId);
                console.log('renderProfileSelect completed');
            }

            /**
             * Loads the filters of a selected profile into the form.
             * @param {string} profileId - The ID of the profile to load.
             */
            function loadProfile(profileId) {
                const profile = profiles[profileId];
                if (!profile) {
                    console.warn('Profile not found:', profileId);
                    currentProfileId = null;
                    updateProfileViewState(null);
                    return;
                }

                // Reset form first to clear previous selections
                form.reset(); 
                // Also reset checkboxes
                form.querySelectorAll('input[type="checkbox"]').forEach(checkbox => checkbox.checked = false);

                // Populate form fields
                const filters = profile.filters;
                for (const key in filters) {
                    const value = filters[key];
                    const input = form.querySelector(`[name="${key}"]`);

                    if (input) {
                        if (input.type === 'checkbox') {
                            // For checkboxes, value is an array
                            if (Array.isArray(value)) {
                                form.querySelectorAll(`input[name="${key}"]`).forEach(checkbox => {
                                    if (value.includes(checkbox.value)) {
                                        checkbox.checked = true;
                                    }
                                });
                            }
                        } else if (input.tagName === 'SELECT') {
                             input.value = value;
                        } 
                        else {
                            input.value = value;
                        }
                    } else {
                        // Handle range inputs like min_price, max_price
                        if (key.startsWith('min_') || key.startsWith('max_')) {
                            const baseName = key.substring(0, key.indexOf('_')); // e.g., 'min' or 'max'
                            const fieldName = key.substring(key.indexOf('_') + 1); // e.g., 'price', 'area'
                            const rangeInput = form.querySelector(`input[name="${key}"]`);
                            if (rangeInput) {
                                rangeInput.value = value;
                            }
                        }
                    }
                }

                currentProfileId = profileId;

                // Update all UI elements related to the profile state
                updateProfileViewState(profileId);

                // Optionally, trigger a scrape for the loaded profile immediately
                // form.dispatchEvent(new Event('submit')); 
            }

            /**
             * Centralized function to update the UI based on the current profile selection.
             * @param {string|null} profileId - The ID of the currently selected profile, or null if none.
             */
            function updateProfileViewState(profileId) {
                const profile = profileId ? profiles[profileId] : null;

                if (profile) {
                    // Show active profile info and edit button
                    activeProfileInfo.classList.remove('hidden');
                    editSearchProfileContainer.classList.remove('hidden');
                    activeProfileNameSpan.textContent = profile.name;
                    activeProfileEmails.textContent = profile.emails && profile.emails.length > 0 
                        ? `${profile.emails.length} email${profile.emails.length > 1 ? 's' : ''} configured`
                        : 'No emails set';
                    
                    // Update new today count
                    const newTodayCountSpan = document.getElementById('new-today-count');
                    if (newTodayCountSpan) {
                        const newTodayCount = profile.new_today_count || 0;
                        newTodayCountSpan.textContent = newTodayCount;
                        
                        // Update visibility and styling based on count
                        const newTodaySection = document.getElementById('active-profile-new-today');
                        if (newTodaySection) {
                            if (newTodayCount > 0) {
                                newTodaySection.classList.remove('text-gray-400');
                                newTodaySection.classList.add('text-green-600');
                            } else {
                                newTodaySection.classList.remove('text-green-600');
                                newTodaySection.classList.add('text-gray-400');
                            }
                        }
                    }
                    
                    // Enable buttons
                    deleteProfileBtn.disabled = false;
                    
                    // Update scrape button to show last scraped time
                    updateScrapeButtonDisplay();

                } else {
                    // Hide active profile info and edit button
                    activeProfileInfo.classList.add('hidden');
                    editSearchProfileContainer.classList.add('hidden');
                    
                    // Clear new today count
                    const newTodayCountSpan = document.getElementById('new-today-count');
                    if (newTodayCountSpan) {
                        newTodayCountSpan.textContent = '0';
                    }
                    
                    // Disable buttons
                    deleteProfileBtn.disabled = true;
                    
                    // Reset scrape button to default display
                    scrapeUpdatesBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                        </svg>
                        <span>Scrape for Updates</span>
                    `;
                }
            }

            /**
             * Updates the scrape button display to show last scraped time.
             */
            function updateScrapeButtonDisplay() {
                if (!currentProfileId || !profiles[currentProfileId]) {
                    scrapeUpdatesBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                        </svg>
                        <span>Scrape for Updates</span>
                    `;
                    return;
                }

                const lastScrapedTime = profiles[currentProfileId].last_scraped 
                    ? new Date(profiles[currentProfileId].last_scraped).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                    : 'Never';
                
                scrapeUpdatesBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                    </svg>
                    <div class="flex flex-col items-start">
                        <span>Scrape for Updates</span>
                        <span class="text-xs opacity-75">Last: ${lastScrapedTime}</span>
                    </div>
                `;
            }

            /**
             * Collects all current filter values from the form.
             * @returns {object} An object containing the current filter settings.
             */
            function getCurrentFilters() {
                const filters = {};
                new FormData(form).forEach((value, key) => {
                    const input = form.querySelector(`[name="${key}"]`);
                    if (input && input.type === 'checkbox') {
                        if (!filters[key]) {
                            filters[key] = [];
                        }
                        if (input.checked) {
                            filters[key].push(value);
                        }
                    } else if (value) {
                        filters[key] = value;
                    }
                });
                // Handle number inputs that might be empty and should be null/undefined
                ['min_price', 'max_price', 'min_area', 'max_area', 'min_rooms', 'max_rooms', 'min_bedrooms', 'max_bedrooms'].forEach(key => {
                    if (filters[key] === '') {
                        delete filters[key];
                    }
                });
                return filters;
            }

            // --- OLD PROFILE FUNCTIONS (kept for compatibility with wizard) ---
            
            /**
             * Saves a new search profile (used by wizard).
             */
            async function saveNewProfile() {
                // This function is now primarily used by the wizard
                // The actual save functionality is handled by the wizard
                showNotification('Please use the "Create New Search Profile" wizard to save profiles.', 'info');
            }

            /**
             * Overwrites the currently selected profile (deprecated).
             */
            async function overwriteSelectedProfile() {
                // This functionality is now handled by the edit profile modal
                showNotification('Please use the "Edit Search Profile" button to update profiles.', 'info');
            }

            /**
             * Updates the email addresses for the currently selected profile (deprecated).
             */
            async function updateProfileEmails() {
                // This functionality is now handled by the edit profile modal
                showNotification('Please use the "Edit Search Profile" button to update emails.', 'info');
            }

            // --- PERIODIC SCRAPING FUNCTIONS (deprecated - now handled by modal) ---

            /**
             * Updates the scraping interval for the current profile (deprecated).
             */
            async function updateScrapeInterval() {
                showNotification('Please use the "Edit Search Profile" button to update scraping intervals.', 'info');
            }

            /**
             * Manually triggers a scrape for the current profile (deprecated).
             */
            async function triggerProfileScrape() {
                showNotification('Please use the "Edit Search Profile" button to trigger scrapes.', 'info');
            }

            /**
             * Fetches the current scraper status.
             */
            async function fetchScraperStatus() {
                try {
                    const response = await fetch('/api/scraper/status');
                    if (!response.ok) throw new Error(`Failed to fetch scraper status: ${response.statusText}`);
                    const status = await response.json();
                    
                    // Update scraper status display
                    if (scraperStatus) {
                        scraperStatus.textContent = status.is_running ? 'Active' : 'Stopped';
                        scraperStatus.className = status.is_running 
                            ? 'text-xs px-2 py-1 rounded-full bg-green-100 text-green-800'
                            : 'text-xs px-2 py-1 rounded-full bg-red-100 text-red-800';
                    }
                    
                    return status;
                } catch (error) {
                    console.error('Error fetching scraper status:', error);
                    return { is_running: false, total_jobs: 0, jobs: [] };
                }
            }

            // --- EDIT PROFILE MODAL FUNCTIONS ---

            /**
             * Opens the edit profile modal and populates it with current profile data.
             */
            function openEditProfileModal() {
                if (!currentProfileId) {
                    showNotification('Please select a profile to edit.', 'warning');
                    return;
                }

                const profile = profiles[currentProfileId];
                if (!profile) {
                    showNotification('Profile not found.', 'error');
                    return;
                }

                // Populate modal fields
                editProfileName.value = profile.name;
                editProfileEmails.value = profile.emails ? profile.emails.join(', ') : '';
                editScrapeInterval.value = profile.scrape_interval_hours || 4;

                // Update status displays
                if (editScraperStatus) {
                    editScraperStatus.textContent = 'Active'; // This would be updated by fetchScraperStatus
                    editScraperStatus.className = 'text-xs px-2 py-1 rounded-full bg-green-100 text-green-800';
                }

                // Update last scraped display
                if (editLastScraped) {
                    if (profile.last_scraped) {
                        const lastScraped = new Date(profile.last_scraped);
                        editLastScraped.textContent = `Last scraped: ${lastScraped.toLocaleDateString()} ${lastScraped.toLocaleTimeString()}`;
                    } else {
                        editLastScraped.textContent = 'Last scraped: Never';
                    }
                }

                // Enable/disable buttons
                editUpdateEmailsBtn.disabled = false;
                editUpdateIntervalBtn.disabled = false;
                editProfileDeleteBtn.disabled = false;
                editProfileSave.disabled = false;

                // Show modal
                editSearchProfileModal.classList.remove('hidden');
            }

            /**
             * Closes the edit profile modal.
             */
            function closeEditProfileModal() {
                editSearchProfileModal.classList.add('hidden');
            }

            /**
             * Updates the email addresses for the current profile from the modal.
             */
            async function updateProfileEmailsFromModal() {
                if (!currentProfileId) {
                    showNotification('Please select a profile to update emails for.', 'warning');
                    return;
                }
                const emails = editProfileEmails.value.split(',').map(email => email.trim()).filter(email => email);

                try {
                    const response = await authManager.apiRequest(`/api/profiles/${currentProfileId}/email`, {
                        method: 'PUT',
                        body: JSON.stringify({ emails: emails })
                    });
                    if (!response.ok) throw new Error(`Failed to update emails: ${response.statusText}`);
                    const result = await response.json();
                    // Update local profile data
                    if (profiles[currentProfileId]) {
                        profiles[currentProfileId].emails = emails;
                        updateProfileViewState(currentProfileId); // Refresh UI
                    }
                    showNotification('Notification emails updated successfully!', 'success');
                } catch (error) {
                    console.error('Error updating emails:', error);
                    showNotification('Could not update notification emails. Please try again.', 'error');
                }
            }

            /**
             * Updates the scraping interval for the current profile from the modal.
             */
            async function updateScrapeIntervalFromModal() {
                if (!currentProfileId) {
                    showNotification('Please select a profile to update the scraping interval for.', 'warning');
                    return;
                }
                
                const intervalHours = parseInt(editScrapeInterval.value);
                if (!intervalHours || intervalHours < 1 || intervalHours > 168) {
                    showNotification('Please enter a valid interval between 1 and 168 hours.', 'warning');
                    return;
                }

                try {
                    const response = await authManager.apiRequest(`/api/profiles/${currentProfileId}/scrape-interval`, {
                        method: 'PUT',
                        body: JSON.stringify({ scrape_interval_hours: intervalHours })
                    });
                    if (!response.ok) throw new Error(`Failed to update interval: ${response.statusText}`);
                    // Update local profile data
                    if (profiles[currentProfileId]) {
                        profiles[currentProfileId].scrape_interval_hours = intervalHours;
                        updateProfileViewState(currentProfileId); // Refresh UI
                    }
                    showNotification(`Scraping interval updated to ${intervalHours} hours.`, 'success');
                } catch (error) {
                    console.error('Error updating scraping interval:', error);
                    showNotification('Could not update scraping interval. Please try again.', 'error');
                }
            }

            /**
             * Saves the profile changes from the modal.
             */
            async function saveProfileChanges() {
                if (!currentProfileId) {
                    showNotification('Please select a profile to save changes for.', 'warning');
                    return;
                }

                const profileName = editProfileName.value.trim();
                if (!profileName) {
                    showNotification('Please enter a profile name.', 'warning');
                    return;
                }

                const profileEmails = editProfileEmails.value.split(',').map(email => email.trim()).filter(email => email);
                const filters = getCurrentFilters();

                try {
                    const response = await authManager.apiRequest(`/api/profiles/${currentProfileId}`, {
                        method: 'PUT',
                        body: JSON.stringify({ name: profileName, filters, emails: profileEmails })
                    });
                    if (!response.ok) throw new Error(`Failed to update profile: ${response.statusText}`);
                    const result = await response.json();
                    // Update the local profile with the response data
                    profiles[currentProfileId] = {
                        id: currentProfileId,
                        name: result.name,
                        filters: result.filters,
                        emails: result.emails || [],
                        listings: result.listings || []
                    };
                    // Refresh the UI
                    renderProfileSelect();
                    updateProfileViewState(currentProfileId);
                    closeEditProfileModal();
                    showNotification(`Profile "${result.name}" updated successfully!`, 'success');
                } catch (error) {
                    console.error('Error updating profile:', error);
                    showNotification('Could not update profile. Please try again.', 'error');
                }
            }
            
            fetchProfiles(); // Load profiles on page load
            fetchListings(null, false); // Fetch initial listings (none selected)

            // Fetch initial scraper status
            fetchScraperStatus();

            // Update scraper status every 30 seconds
            setInterval(fetchScraperStatus, 30000);

            // Refresh listings every 5 minutes if a profile is selected
            setInterval(() => {
                if (currentProfileId) {
                    fetchListings(currentProfileId, false);
                }
            }, 300000); // 5 minutes

            // Create New Search Profile Wizard Button
            createNewProfileBtn.addEventListener('click', () => {
                openWizard();
            });

            // Attach event listeners for the new save profile button
            const saveProfileBtn = document.getElementById('save-profile-btn');
            if (saveProfileBtn) {
                saveProfileBtn.addEventListener('click', saveNewProfile);
            }

            // Edit profile modal event listeners
            editSearchProfileBtn.addEventListener('click', openEditProfileModal);
            editProfileClose.addEventListener('click', closeEditProfileModal);
            editProfileCancel.addEventListener('click', closeEditProfileModal);
            editProfileSave.addEventListener('click', saveProfileChanges);
            editUpdateEmailsBtn.addEventListener('click', updateProfileEmailsFromModal);
            editUpdateIntervalBtn.addEventListener('click', updateScrapeIntervalFromModal);
            editProfileDeleteBtn.addEventListener('click', () => {
                if (!currentProfileId) return;
                
                const profileName = profiles[currentProfileId]?.name || 'this profile';
                showConfirmation(
                    'Delete Profile',
                    `Are you sure you want to delete "${profileName}"? This cannot be undone.`,
                    async () => {
                        try {
                            const response = await authManager.apiRequest(`/api/profiles/${encodeURIComponent(currentProfileId)}`, { method: 'DELETE' });
                            if (!response.ok && response.status !== 204) throw new Error('Failed to delete profile');
                            // Remove from local profiles object
                            delete profiles[currentProfileId];
                            // Reset UI
                            currentProfileId = null;
                            profileSelect.value = '';
                            form.reset();
                            closeEditProfileModal();
                            updateProfileViewState(null);
                            await fetchProfiles();
                            fetchListings(null, false);
                            showNotification('Profile deleted successfully.', 'success');
                        } catch (error) {
                            showNotification('Failed to delete profile.', 'error');
                        }
                    }
                );
            });

            // Enable/disable buttons based on input changes in modal
            editProfileEmails.addEventListener('input', () => {
                if (currentProfileId) {
                    const currentEmails = profiles[currentProfileId].emails ? profiles[currentProfileId].emails.join(', ') : '';
                    editUpdateEmailsBtn.disabled = editProfileEmails.value.trim() === currentEmails;
                }
            });

            editScrapeInterval.addEventListener('input', () => {
                if (currentProfileId && editUpdateIntervalBtn) {
                    const currentInterval = profiles[currentProfileId]?.scrape_interval_hours || 4;
                    const newInterval = parseInt(editScrapeInterval.value);
                    editUpdateIntervalBtn.disabled = !newInterval || newInterval === currentInterval;
                }
            });

            // Close modal when clicking outside
            editSearchProfileModal.addEventListener('click', (e) => {
                if (e.target === editSearchProfileModal) {
                    closeEditProfileModal();
                }
            });

            // Close modal with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !editSearchProfileModal.classList.contains('hidden')) {
                    closeEditProfileModal();
                }
            });

            // Edit profile modal event listeners
            profileSelect.addEventListener('change', (event) => {
                const selectedProfileId = event.target.value;
                currentProfileId = selectedProfileId || null;

                if (currentProfileId) {
                    loadProfile(currentProfileId);
                    fetchListings(currentProfileId, false); // Fetch listings for selected profile
                } else {
                    // If "Select a saved profile..." is chosen, reset everything
                    form.reset(); // Clear all form filters
                    updateProfileViewState(null); // Hide profile-specific sections
                    fetchListings(null, false); // Show initial/empty state
                }
            });

            // Edit profile button - now opens the modal
            editProfileBtn.addEventListener('click', openEditProfileModal);

            // Delete profile button
            deleteProfileBtn.addEventListener('click', async () => {
                if (!currentProfileId) return;
                
                const profileName = profiles[currentProfileId]?.name || 'this profile';
                showConfirmation(
                    'Delete Profile',
                    `Are you sure you want to delete "${profileName}"? This cannot be undone.`,
                    async () => {
                        try {
                            const response = await authManager.apiRequest(`/api/profiles/${encodeURIComponent(currentProfileId)}`, { method: 'DELETE' });
                            if (!response.ok && response.status !== 204) throw new Error('Failed to delete profile');
                            // Remove from local profiles object
                            delete profiles[currentProfileId];
                            // Reset UI
                            currentProfileId = null;
                            profileSelect.value = '';
                            form.reset();
                            updateProfileViewState(null); // <-- Ensure UI disables buttons and hides info
                            await fetchProfiles(); // This will re-render the select and update the view
                            fetchListings(null, false);
                            showNotification('Profile deleted successfully.', 'success');
                        } catch (error) {
                            showNotification('Failed to delete profile.', 'error');
                        }
                    }
                );
            });

            // Handle form submission for scraping updates
            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                if (!currentProfileId) {
                    showNotification('Please select a profile to scrape for updates.', 'warning');
                    return;
                }
                const filters = getCurrentFilters();
                try {
                    // Show loading state
                    scrapeUpdatesBtn.disabled = true;
                    scrapeUpdatesBtn.innerHTML = `
                        <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Scraping...
                    `;
                    
                    // POST filters to /api/profiles/{profile_id}/scrape
                    const response = await authManager.apiRequest(`/api/profiles/${encodeURIComponent(currentProfileId)}/scrape`, {
                        method: 'POST',
                        body: JSON.stringify({ filters })
                    });
                    if (!response.ok) throw new Error(`Scrape failed: ${response.statusText}`);
                    
                    // Show success message
                    scrapeUpdatesBtn.innerHTML = `
                        <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        Scrape Complete!
                    `;
                    
                    showNotification('Scraping completed successfully!', 'success');
                    
                    // Update the last scraped time in the profile
                    if (profiles[currentProfileId]) {
                        profiles[currentProfileId].last_scraped = new Date().toISOString();
                        updateProfileViewState(currentProfileId);
                    }
                    
                    // Refresh listings for this profile
                    await fetchListings(currentProfileId, true);
                    
                    // Reset button after delay
                    setTimeout(() => {
                        // Show last scraped time in the button text
                        const lastScrapedTime = profiles[currentProfileId]?.last_scraped 
                            ? new Date(profiles[currentProfileId].last_scraped).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                            : 'Never';
                        scrapeUpdatesBtn.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                            </svg>
                            <div class="flex flex-col items-start">
                                <span>Scrape for Updates</span>
                                <span class="text-xs opacity-75">Last: ${lastScrapedTime}</span>
                            </div>
                        `;
                        scrapeUpdatesBtn.disabled = false;
                    }, 2000);
                } catch (error) {
                    console.error('Error scraping for updates:', error);
                    showNotification('Could not scrape for updates. Please try again.', 'error');
                    // Reset button with last scraped time
                    const lastScrapedTime = profiles[currentProfileId]?.last_scraped 
                        ? new Date(profiles[currentProfileId].last_scraped).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                        : 'Never';
                    scrapeUpdatesBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                        </svg>
                        <div class="flex flex-col items-start">
                            <span>Scrape for Updates</span>
                            <span class="text-xs opacity-75">Last: ${lastScrapedTime}</span>
                        </div>
                    `;
                    scrapeUpdatesBtn.disabled = false;
                }
            });

            // --- PROFILE WIZARD FUNCTIONALITY ---
            
            let currentWizardStep = 1;
            let wizardData = {};
            
            // Initialize wizard event listeners
            createNewProfileBtn.addEventListener('click', () => {
                openWizard();
            });
            
            wizardCloseBtn.addEventListener('click', () => {
                closeWizard();
            });
            
            wizardPrevBtn.addEventListener('click', () => {
                goToPreviousStep();
            });
            
            wizardNextBtn.addEventListener('click', () => {
                goToNextStep();
            });
            
            wizardSkipBtn.addEventListener('click', () => {
                goToNextStep();
            });
            
            wizardCreateBtn.addEventListener('click', () => {
                createProfileFromWizard();
            });
            
            // Location selection handlers
            document.querySelectorAll('.location-option').forEach(option => {
                option.addEventListener('click', () => {
                    selectLocationOption(option);
                });
                
                // Add keyboard navigation
                option.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        selectLocationOption(option);
                    }
                });
                
                // Make options focusable
                option.setAttribute('tabindex', '0');
            });
            
            // Add keyboard navigation for wizard
            profileWizardModal.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeWizard();
                }
            });
            
            // Wizard functions
            function openWizard() {
                currentWizardStep = 1;
                wizardData = {};
                updateWizardUI();
                profileWizardModal.classList.remove('hidden');
            }
            
            function closeWizard() {
                profileWizardModal.classList.add('hidden');
                currentWizardStep = 1;
                wizardData = {};
                resetWizardForm();
            }
            
            function updateWizardUI() {
                // Update step indicator
                wizardCurrentStepSpan.textContent = currentWizardStep;
                
                // Update progress bar
                const progressPercentage = (currentWizardStep / 4) * 100;
                wizardProgress.style.width = `${progressPercentage}%`;
                
                // Show/hide step content
                document.querySelectorAll('.wizard-step').forEach((step, index) => {
                    if (index + 1 === currentWizardStep) {
                        step.classList.remove('hidden');
                    } else {
                        step.classList.add('hidden');
                    }
                });
                
                // Update navigation buttons
                wizardPrevBtn.classList.toggle('hidden', currentWizardStep === 1);
                wizardNextBtn.classList.toggle('hidden', currentWizardStep === 4);
                wizardCreateBtn.classList.toggle('hidden', currentWizardStep !== 4);
                wizardSkipBtn.classList.toggle('hidden', currentWizardStep === 4);
            }
            
            function selectLocationOption(option) {
                // Remove selection from all options
                document.querySelectorAll('.location-option').forEach(opt => {
                    opt.classList.remove('border-primary', 'bg-primary/10');
                    opt.classList.add('border-gray-200');
                    opt.querySelector('.location-radio').innerHTML = '';
                });
                
                // Add selection to clicked option
                option.classList.remove('border-gray-200');
                option.classList.add('border-primary', 'bg-primary/10');
                option.querySelector('.location-radio').innerHTML = `
                    <div class="w-3 h-3 bg-primary rounded-full"></div>
                `;
                
                // Show/hide relevant input fields
                const locationType = option.dataset.locationType;
                wizardData.locationType = locationType;
                
                document.querySelectorAll('.city-options, .radius-options, .travel-time-options').forEach(el => {
                    el.style.display = 'none';
                });
                
                if (locationType === 'city') {
                    document.querySelector('.city-options').style.display = 'block';
                } else if (locationType === 'radius') {
                    document.querySelector('.radius-options').style.display = 'block';
                } else if (locationType === 'travel-time') {
                    document.querySelector('.travel-time-options').style.display = 'block';
                }
            }
            
            function goToNextStep() {
                if (validateCurrentStep()) {
                    collectCurrentStepData();
                    currentWizardStep++;
                    updateWizardUI();
                }
            }
            
            function goToPreviousStep() {
                if (currentWizardStep > 1) {
                    currentWizardStep--;
                    updateWizardUI();
                }
            }
            
            function validateCurrentStep() {
                if (currentWizardStep === 1) {
                    if (!wizardData.locationType) {
                        showNotification('Please select a location method.', 'warning');
                        return false;
                    }
                    
                    if (wizardData.locationType === 'city') {
                        const cityInput = document.getElementById('city-input').value.trim();
                        if (!cityInput) {
                            showNotification('Please enter a city name.', 'warning');
                            document.getElementById('city-input').focus();
                            return false;
                        }
                    } else if (wizardData.locationType === 'radius') {
                        const centerInput = document.getElementById('radius-center').value.trim();
                        const distanceInput = document.getElementById('radius-distance').value;
                        if (!centerInput) {
                            showNotification('Please enter a center location.', 'warning');
                            document.getElementById('radius-center').focus();
                            return false;
                        }
                        if (!distanceInput) {
                            showNotification('Please select a radius distance.', 'warning');
                            document.getElementById('radius-distance').focus();
                            return false;
                        }
                    } else if (wizardData.locationType === 'travel-time') {
                        const centerInput = document.getElementById('travel-center').value.trim();
                        const timeInput = document.getElementById('travel-time').value;
                        const modeInput = document.getElementById('transport-mode').value;
                        if (!centerInput) {
                            showNotification('Please enter a starting location.', 'warning');
                            document.getElementById('travel-center').focus();
                            return false;
                        }
                        if (!timeInput) {
                            showNotification('Please select a travel time.', 'warning');
                            document.getElementById('travel-time').focus();
                            return false;
                        }
                        if (!modeInput) {
                            showNotification('Please select a transport mode.', 'warning');
                            document.getElementById('transport-mode').focus();
                            return false;
                        }
                    }
                } else if (currentWizardStep === 4) {
                    const profileName = document.getElementById('wizard-profile-name').value.trim();
                    if (!profileName) {
                        showNotification('Please enter a profile name.', 'warning');
                        document.getElementById('wizard-profile-name').focus();
                        return false;
                    }
                    
                    // Validate email format if provided
                    const emailsInput = document.getElementById('wizard-emails').value.trim();
                    if (emailsInput) {
                        const emails = emailsInput.split(',').map(e => e.trim());
                        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        for (const email of emails) {
                            if (email && !emailRegex.test(email)) {
                                showNotification(`Invalid email format: ${email}`, 'warning');
                                document.getElementById('wizard-emails').focus();
                                return false;
                            }
                        }
                    }
                }
                return true;
            }
            
            function collectCurrentStepData() {
                if (currentWizardStep === 1) {
                    // Location data
                    if (wizardData.locationType === 'city') {
                        wizardData.city = document.getElementById('city-input').value.trim();
                    } else if (wizardData.locationType === 'radius') {
                        wizardData.radiusCenter = document.getElementById('radius-center').value.trim();
                        wizardData.radiusDistance = document.getElementById('radius-distance').value;
                    } else if (wizardData.locationType === 'travel-time') {
                        wizardData.travelCenter = document.getElementById('travel-center').value.trim();
                        wizardData.travelTime = document.getElementById('travel-time').value;
                        wizardData.transportMode = document.getElementById('transport-mode').value;
                    }
                } else if (currentWizardStep === 2) {
                    // Basic requirements
                    wizardData.minPrice = document.getElementById('wizard-min-price').value;
                    wizardData.maxPrice = document.getElementById('wizard-max-price').value;
                    wizardData.minBedrooms = document.getElementById('wizard-min-bedrooms').value;
                    wizardData.maxBedrooms = document.getElementById('wizard-max-bedrooms').value;
                    wizardData.minArea = document.getElementById('wizard-min-area').value;
                    wizardData.maxArea = document.getElementById('wizard-max-area').value;
                } else if (currentWizardStep === 3) {
                    // Detailed filters
                    wizardData.propertyTypes = [];
                    document.querySelectorAll('input[name="wizard-property-type"]:checked').forEach(cb => {
                        wizardData.propertyTypes.push(cb.value);
                    });
                    wizardData.energyLabel = document.getElementById('wizard-energy-label').value;
                    wizardData.hasBalcony = document.getElementById('wizard-balcony').checked;
                    wizardData.hasGarden = document.getElementById('wizard-garden').checked;
                    wizardData.hasRoofTerrace = document.getElementById('wizard-roof-terrace').checked;
                    wizardData.furnished = document.getElementById('wizard-furnished').checked;
                    wizardData.partlyFurnished = document.getElementById('wizard-partly-furnished').checked;
                    wizardData.hasParking = document.getElementById('wizard-parking').checked;
                    wizardData.hasGarage = document.getElementById('wizard-garage').checked;
                    wizardData.hasLift = document.getElementById('wizard-lift').checked;
                    wizardData.hasDisabledAccess = document.getElementById('wizard-disabled-access').checked;
                } else if (currentWizardStep === 4) {
                    // Profile setup
                    wizardData.profileName = document.getElementById('wizard-profile-name').value.trim();
                    wizardData.emails = document.getElementById('wizard-emails').value.trim();
                    wizardData.scrapeInterval = document.getElementById('wizard-scrape-interval').value;
                }
            }
            
            function resetWizardForm() {
                // Reset all form fields
                document.getElementById('city-input').value = '';
                document.getElementById('radius-center').value = '';
                document.getElementById('radius-distance').value = '';
                document.getElementById('travel-center').value = '';
                document.getElementById('travel-time').value = '';
                document.getElementById('transport-mode').value = '';
                document.getElementById('wizard-min-price').value = '';
                document.getElementById('wizard-max-price').value = '';
                document.getElementById('wizard-min-bedrooms').value = '';
                document.getElementById('wizard-max-bedrooms').value = '';
                document.getElementById('wizard-min-area').value = '';
                document.getElementById('wizard-max-area').value = '';
                document.getElementById('wizard-energy-label').value = '';
                document.getElementById('wizard-profile-name').value = '';
                document.getElementById('wizard-emails').value = '';
                document.getElementById('wizard-scrape-interval').value = '4';
                
                // Reset checkboxes
                document.querySelectorAll('input[name="wizard-property-type"]').forEach(cb => cb.checked = false);
                document.getElementById('wizard-balcony').checked = false;
                document.getElementById('wizard-garden').checked = false;
                document.getElementById('wizard-roof-terrace').checked = false;
                document.getElementById('wizard-furnished').checked = false;
                document.getElementById('wizard-partly-furnished').checked = false;
                document.getElementById('wizard-parking').checked = false;
                document.getElementById('wizard-garage').checked = false;
                document.getElementById('wizard-lift').checked = false;
                document.getElementById('wizard-disabled-access').checked = false;
                
                // Reset location selection
                document.querySelectorAll('.location-option').forEach(opt => {
                    opt.classList.remove('border-primary', 'bg-primary/10');
                    opt.classList.add('border-gray-200');
                    opt.querySelector('.location-radio').innerHTML = '';
                });
                
                // Hide all input sections
                document.querySelectorAll('.city-options, .radius-options, .travel-time-options').forEach(el => {
                    el.style.display = 'none';
                });
            }
            
            async function createProfileFromWizard() {
                if (!validateCurrentStep()) return;
                
                collectCurrentStepData();
                
                // Show loading state
                wizardCreateBtn.disabled = true;
                wizardCreateBtn.innerHTML = `
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                        Creating Profile...
                    </div>
                `;
                
                try {
                    // Convert wizard data to profile format
                    const profileData = convertWizardDataToProfile(wizardData);
                    
                    // Save the profile
                    const response = await authManager.apiRequest('/api/profiles', {
                        method: 'POST',
                        body: JSON.stringify(profileData)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.detail || 'Failed to create profile');
                    }
                    
                    const result = await response.json();
                    
                    // Success
                    showNotification(`Profile "${profileData.name}" created successfully!`, 'success');
                    closeWizard();
                    await fetchProfiles(); // Refresh profiles list
                    
                    // Optionally load the newly created profile
                    if (result.profileId) {
                        currentProfileId = result.profileId;
                        profileSelect.value = result.profileId;
                        loadProfile(result.profileId);
                        fetchListings(result.profileId, false);
                    }
                    
                } catch (error) {
                    console.error('Error creating profile:', error);
                    showNotification(`Failed to create profile: ${error.message}`, 'error');
                } finally {
                    // Reset button state
                    wizardCreateBtn.disabled = false;
                    wizardCreateBtn.innerHTML = `
                        <span class="flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Create Profile
                        </span>
                    `;
                }
            }
            
            function convertWizardDataToProfile(data) {
                const profile = {
                    name: data.profileName,
                    emails: data.emails ? data.emails.split(',').map(e => e.trim()).filter(e => e) : [],
                    scrape_interval_hours: parseInt(data.scrapeInterval) || 4,
                    filters: {}
                };
                
                // Convert location data
                if (data.locationType === 'city' && data.city) {
                    profile.filters.city = data.city;
                }
                // Note: radius and travel-time would need backend support
                
                // Convert basic requirements
                if (data.minPrice) profile.filters.min_price = parseInt(data.minPrice);
                if (data.maxPrice) profile.filters.max_price = parseInt(data.maxPrice);
                if (data.minBedrooms) profile.filters.min_bedrooms = parseInt(data.minBedrooms);
                if (data.maxBedrooms) profile.filters.max_bedrooms = parseInt(data.maxBedrooms);
                if (data.minArea) profile.filters.min_floor_area = parseInt(data.minArea);
                if (data.maxArea) profile.filters.max_floor_area = parseInt(data.maxArea);
                
                // Convert detailed filters
                if (data.propertyTypes && data.propertyTypes.length > 0) {
                    profile.filters.property_types = data.propertyTypes;
                }
                if (data.energyLabel) profile.filters.energy_label = data.energyLabel;
                if (data.hasBalcony) profile.filters.has_balcony = true;
                if (data.hasGarden) profile.filters.has_garden = true;
                if (data.hasRoofTerrace) profile.filters.has_roof_terrace = true;
                if (data.furnished) profile.filters.furnished = true;
                if (data.partlyFurnished) profile.filters.partly_furnished = true;
                if (data.hasParking) profile.filters.has_parking = true;
                if (data.hasGarage) profile.filters.has_garage = true;
                if (data.hasLift) profile.filters.has_lift = true;
                if (data.hasDisabledAccess) profile.filters.has_disabled_access = true;
                
                return profile;
            }

        }); // End of DOMContentLoaded event handler

    </script>
    
    <!-- Custom Notification System -->
    <div id="notification-container" class="fixed top-4 right-4 z-50 space-y-2"></div>
    
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h2 id="confirmation-title" class="text-lg font-bold mb-3 text-secondary">Confirm Action</h2>
            <p id="confirmation-message" class="text-gray-700 mb-4">Are you sure you want to proceed?</p>
            <div class="flex justify-end gap-2">
                <button type="button" id="confirmation-cancel" class="px-4 py-2 rounded bg-gray-100 text-gray-700 hover:bg-gray-200">Cancel</button>
                <button type="button" id="confirmation-confirm" class="px-4 py-2 rounded bg-red-500 text-white hover:bg-red-600">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Search Profile Modal -->
    <div id="edit-search-profile-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-secondary">Edit Search Profile</h2>
                        <p class="text-sm text-gray-500">Manage your search profile settings</p>
                    </div>
                </div>
                <button id="edit-profile-close" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                    <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Modal Content -->
            <div class="flex-1 overflow-y-auto p-6 space-y-6">
                <!-- Profile Name -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Profile Name</label>
                    <input type="text" id="edit-profile-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Enter profile name">
                </div>

                <!-- Email Notifications -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email Notifications</label>
                    <div class="flex gap-2">
                        <input type="text" id="edit-profile-emails" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Enter emails, comma separated">
                        <button id="edit-update-emails-btn" class="px-4 py-2 bg-primary text-white text-sm font-medium rounded-lg hover:bg-primary-600 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            Update
                        </button>
                    </div>
                </div>

                <!-- Periodic Scraping -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Periodic Scraping</label>
                    <div class="p-4 bg-blue-50 rounded-lg">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-sm font-medium text-gray-700">Status</span>
                            <span id="edit-scraper-status" class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-800">Active</span>
                        </div>
                        <div class="space-y-3">
                            <div class="flex items-center gap-2">
                                <label class="text-sm text-gray-600">Interval (hours):</label>
                                <input type="number" id="edit-scrape-interval" class="w-20 px-2 py-1 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" value="4" min="1" max="168">
                                <button id="edit-update-interval-btn" class="px-3 py-1 text-sm bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-200" disabled>Update</button>
                            </div>
                            <div class="text-xs text-gray-500">
                                <span id="edit-last-scraped">Last scraped: Never</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="flex justify-between items-center p-6 border-t border-gray-200">
                <button id="edit-profile-delete-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    Delete Profile
                </button>
                <div class="flex gap-2">
                    <button id="edit-profile-cancel" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition duration-200">
                        Cancel
                    </button>
                    <button id="edit-profile-save" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-600 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Create New Search Profile Wizard -->
    <div id="profile-wizard-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[90vh] overflow-hidden flex flex-col">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-secondary">Create New Search Profile</h2>
                        <p class="text-sm text-gray-500">Step <span id="wizard-current-step">1</span> of 4</p>
                    </div>
                </div>
                <button id="wizard-close" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Progress Bar -->
            <div class="px-6 py-4 border-b border-gray-100">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-gray-700">Location</span>
                    <span class="text-sm font-medium text-gray-700">Requirements</span>
                    <span class="text-sm font-medium text-gray-700">Details</span>
                    <span class="text-sm font-medium text-gray-700">Setup</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div id="wizard-progress" class="bg-primary h-2 rounded-full transition-all duration-300" style="width: 25%"></div>
                </div>
            </div>

            <!-- Modal Content -->
            <div class="flex-1 overflow-y-auto">
                
                <!-- Step 1: Location Selection -->
                <div id="wizard-step-1" class="wizard-step p-6">
                    <div class="max-w-2xl mx-auto">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-4m-5 0H3m2 0h4M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                </svg>
                            </div>
                            <h3 class="text-2xl font-bold text-secondary mb-2">Where would you like to search?</h3>
                            <p class="text-gray-600">Choose your preferred location method</p>
                        </div>

                        <div class="space-y-4">
                            <!-- City Selection -->
                            <div class="location-option border-2 border-gray-200 rounded-xl p-6 cursor-pointer hover:border-primary hover:bg-primary/5 transition-all" data-location-type="city">
                                <div class="flex items-start gap-4">
                                    <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-4m-5 0H3m2 0h4M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <h4 class="font-semibold text-lg text-secondary mb-1">Search by City</h4>
                                        <p class="text-gray-600 mb-3">Search within specific cities or municipalities</p>
                                        <div class="city-options" style="display: none;">
                                            <input type="text" id="city-input" placeholder="Enter city name (e.g., Amsterdam, Utrecht)" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                        </div>
                                    </div>
                                    <div class="location-radio w-5 h-5 border-2 border-gray-300 rounded-full flex-shrink-0"></div>
                                </div>
                            </div>

                            <!-- Radius Selection -->
                            <div class="location-option border-2 border-gray-200 rounded-xl p-6 cursor-pointer hover:border-primary hover:bg-primary/5 transition-all" data-location-type="radius">
                                <div class="flex items-start gap-4">
                                    <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <h4 class="font-semibold text-lg text-secondary mb-1">Search by Radius</h4>
                                        <p class="text-gray-600 mb-3">Search within a specific distance from a location</p>
                                        <div class="radius-options" style="display: none;">
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-2">Center Location</label>
                                                    <input type="text" id="radius-center" placeholder="Enter address or city" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-2">Radius (km)</label>
                                                    <select id="radius-distance" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                                        <option value="">Select distance</option>
                                                        <option value="1">1 km</option>
                                                        <option value="2">2 km</option>
                                                        <option value="5">5 km</option>
                                                        <option value="10">10 km</option>
                                                        <option value="15">15 km</option>
                                                        <option value="20">20 km</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="location-radio w-5 h-5 border-2 border-gray-300 rounded-full flex-shrink-0"></div>
                                </div>
                            </div>

                            <!-- Travel Time Selection -->
                            <div class="location-option border-2 border-gray-200 rounded-xl p-6 cursor-pointer hover:border-primary hover:bg-primary/5 transition-all" data-location-type="travel-time">
                                <div class="flex items-start gap-4">
                                    <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                        <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <h4 class="font-semibold text-lg text-secondary mb-1">Search by Travel Time</h4>
                                        <p class="text-gray-600 mb-3">Search within a specific travel time from a location</p>
                                        <div class="travel-time-options" style="display: none;">
                                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-2">From Location</label>
                                                    <input type="text" id="travel-center" placeholder="Enter address" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-2">Travel Time</label>
                                                    <select id="travel-time" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                                        <option value="">Select time</option>
                                                        <option value="15">15 minutes</option>
                                                        <option value="30">30 minutes</option>
                                                        <option value="45">45 minutes</option>
                                                        <option value="60">1 hour</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-2">Transport Mode</label>
                                                    <select id="transport-mode" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                                        <option value="">Select mode</option>
                                                        <option value="walking">Walking</option>
                                                        <option value="cycling">Cycling</option>
                                                        <option value="public-transport">Public Transport</option>
                                                        <option value="driving">Driving</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="location-radio w-5 h-5 border-2 border-gray-300 rounded-full flex-shrink-0"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Basic Requirements -->
                <div id="wizard-step-2" class="wizard-step p-6 hidden">
                    <div class="max-w-2xl mx-auto">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-8 h-8 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                </svg>
                            </div>
                            <h3 class="text-2xl font-bold text-secondary mb-2">What are your main requirements?</h3>
                            <p class="text-gray-600">Set your budget and space needs</p>
                        </div>

                        <div class="space-y-6">
                            <!-- Price Range -->
                            <div class="bg-gray-50 rounded-xl p-6">
                                <h4 class="font-semibold text-lg text-secondary mb-4 flex items-center gap-2">
                                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                    </svg>
                                    Price Range (€)
                                </h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Minimum Price</label>
                                        <input type="number" id="wizard-min-price" placeholder="e.g. 800" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Maximum Price</label>
                                        <input type="number" id="wizard-max-price" placeholder="e.g. 2500" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                    </div>
                                </div>
                            </div>

                            <!-- Bedrooms -->
                            <div class="bg-gray-50 rounded-xl p-6">
                                <h4 class="font-semibold text-lg text-secondary mb-4 flex items-center gap-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                                    </svg>
                                    Bedrooms
                                </h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Minimum Bedrooms</label>
                                        <select id="wizard-min-bedrooms" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                            <option value="">Any</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5+</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Maximum Bedrooms</label>
                                        <select id="wizard-max-bedrooms" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                            <option value="">Any</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5+</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Floor Area -->
                            <div class="bg-gray-50 rounded-xl p-6">
                                <h4 class="font-semibold text-lg text-secondary mb-4 flex items-center gap-2">
                                    <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                                    </svg>
                                    Floor Area (m²)
                                </h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Minimum Area</label>
                                        <input type="number" id="wizard-min-area" placeholder="e.g. 50" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Maximum Area</label>
                                        <input type="number" id="wizard-max-area" placeholder="e.g. 150" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Detailed Filters -->
                <div id="wizard-step-3" class="wizard-step p-6 hidden">
                    <div class="max-w-4xl mx-auto">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
                                </svg>
                            </div>
                            <h3 class="text-2xl font-bold text-secondary mb-2">Additional preferences</h3>
                            <p class="text-gray-600">Fine-tune your search with detailed filters</p>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Property Features -->
                            <div class="space-y-6">
                                <div class="bg-gray-50 rounded-xl p-6">
                                    <h4 class="font-semibold text-lg text-secondary mb-4">Property Type</h4>
                                    <div class="space-y-3">
                                        <label class="flex items-center gap-3">
                                            <input type="checkbox" name="wizard-property-type" value="apartment" class="form-checkbox">
                                            <span class="text-sm">Apartment</span>
                                        </label>
                                        <label class="flex items-center gap-3">
                                            <input type="checkbox" name="wizard-property-type" value="house" class="form-checkbox">
                                            <span class="text-sm">House</span>
                                        </label>
                                        <label class="flex items-center gap-3">
                                            <input type="checkbox" name="wizard-property-type" value="studio" class="form-checkbox">
                                            <span class="text-sm">Studio</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="bg-gray-50 rounded-xl p-6">
                                    <h4 class="font-semibold text-lg text-secondary mb-4">Energy Label</h4>
                                    <select id="wizard-energy-label" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                        <option value="">Any</option>
                                        <option value="A+++">A+++</option>
                                        <option value="A++">A++</option>
                                        <option value="A+">A+</option>
                                        <option value="A">A</option>
                                        <option value="B">B or better</option>
                                        <option value="C">C or better</option>
                                    </select>
                                </div>

                                <div class="bg-gray-50 rounded-xl p-6">
                                    <h4 class="font-semibold text-lg text-secondary mb-4">Outdoor Space</h4>
                                    <div class="space-y-3">
                                        <label class="flex items-center gap-3">
                                            <input type="checkbox" id="wizard-balcony" class="form-checkbox">
                                            <span class="text-sm">Balcony</span>
                                        </label>
                                        <label class="flex items-center gap-3">
                                            <input type="checkbox" id="wizard-garden" class="form-checkbox">
                                            <span class="text-sm">Garden</span>
                                        </label>
                                        <label class="flex items-center gap-3">
                                            <input type="checkbox" id="wizard-roof-terrace" class="form-checkbox">
                                            <span class="text-sm">Roof Terrace</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Amenities & Features -->
                            <div class="space-y-6">
                                <div class="bg-gray-50 rounded-xl p-6">
                                    <h4 class="font-semibold text-lg text-secondary mb-4">Furnishing</h4>
                                    <div class="space-y-3">
                                        <label class="flex items-center gap-3">
                                            <input type="checkbox" id="wizard-furnished" class="form-checkbox">
                                            <span class="text-sm">Furnished</span>
                                        </label>
                                        <label class="flex items-center gap-3">
                                            <input type="checkbox" id="wizard-partly-furnished" class="form-checkbox">
                                            <span class="text-sm">Partly Furnished</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="bg-gray-50 rounded-xl p-6">
                                    <h4 class="font-semibold text-lg text-secondary mb-4">Parking & Storage</h4>
                                    <div class="space-y-3">
                                        <label class="flex items-center gap-3">
                                            <input type="checkbox" id="wizard-parking" class="form-checkbox">
                                            <span class="text-sm">Parking</span>
                                        </label>
                                        <label class="flex items-center gap-3">
                                            <input type="checkbox" id="wizard-garage" class="form-checkbox">
                                            <span class="text-sm">Garage</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="bg-gray-50 rounded-xl p-6">
                                    <h4 class="font-semibold text-lg text-secondary mb-4">Accessibility</h4>
                                    <div class="space-y-3">
                                        <label class="flex items-center gap-3">
                                            <input type="checkbox" id="wizard-lift" class="form-checkbox">
                                            <span class="text-sm">Elevator</span>
                                        </label>
                                        <label class="flex items-center gap-3">
                                            <input type="checkbox" id="wizard-disabled-access" class="form-checkbox">
                                            <span class="text-sm">Disabled Access</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Profile Setup -->
                <div id="wizard-step-4" class="wizard-step p-6 hidden">
                    <div class="max-w-2xl mx-auto">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                            <h3 class="text-2xl font-bold text-secondary mb-2">Profile setup</h3>
                            <p class="text-gray-600">Name your profile and configure notifications</p>
                        </div>

                        <div class="space-y-6">
                            <!-- Profile Name -->
                            <div class="bg-gray-50 rounded-xl p-6">
                                <h4 class="font-semibold text-lg text-secondary mb-4 flex items-center gap-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                    </svg>
                                    Profile Name
                                </h4>
                                <input type="text" id="wizard-profile-name" placeholder="e.g., Amsterdam City Center Search" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-lg">
                            </div>

                            <!-- Email Notifications -->
                            <div class="bg-gray-50 rounded-xl p-6">
                                <h4 class="font-semibold text-lg text-secondary mb-4 flex items-center gap-2">
                                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                    </svg>
                                    Email Notifications
                                </h4>
                                <div class="space-y-3">
                                    <textarea id="wizard-emails" rows="3" placeholder="Enter email addresses separated by commas&#10;e.g., john@example.com, jane@example.com" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent resize-none"></textarea>
                                    <p class="text-sm text-gray-600">You'll receive notifications when new properties matching your criteria are found.</p>
                                </div>
                            </div>

                            <!-- Scraping Frequency -->
                            <div class="bg-gray-50 rounded-xl p-6">
                                <h4 class="font-semibold text-lg text-secondary mb-4 flex items-center gap-2">
                                    <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    Search Frequency
                                </h4>
                                <select id="wizard-scrape-interval" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <option value="1">Every hour</option>
                                    <option value="2">Every 2 hours</option>
                                    <option value="4" selected>Every 4 hours (recommended)</option>
                                    <option value="6">Every 6 hours</option>
                                    <option value="12">Twice daily</option>
                                    <option value="24">Daily</option>
                                </select>
                                <p class="text-sm text-gray-600 mt-2">How often should we check for new properties?</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="p-6 border-t border-gray-200 flex items-center justify-between">
                <button id="wizard-prev" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors hidden">
                    <span class="flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        Previous
                    </span>
                </button>
                <div class="flex gap-3">
                    <button id="wizard-skip" class="px-6 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                        Skip this step
                    </button>
                    <button id="wizard-next" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary-600 transition-colors">
                        <span class="flex items-center gap-2">
                            Next
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </span>
                    </button>
                    <button id="wizard-create" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors hidden">
                        <span class="flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Create Profile
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900" id="confirmation-title">Confirm Action</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500" id="confirmation-message">Are you sure you want to proceed?</p>
                </div>
                <div class="items-center px-4 py-3 flex justify-end gap-2">
                    <button id="confirmation-cancel" class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400">Cancel</button>
                    <button id="confirmation-confirm" class="px-4 py-2 rounded text-white bg-red-500 hover:bg-red-600">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Load authentication script -->
    <script src="/static/auth.js"></script>
    
    <script>
        // Initialize authentication UI
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Initializing authentication...');
            
            // Wait for auth.js to load
            function initializeAuth() {
                if (typeof authManager === 'undefined' || typeof authUI === 'undefined') {
                    console.log('Auth components not loaded yet, retrying...');
                    setTimeout(initializeAuth, 100);
                    return;
                }
                
                console.log('Auth components loaded, setting up event listeners...');
                
                // Setup authentication event listeners
                const loginBtn = document.getElementById('login-btn');
                const registerBtn = document.getElementById('register-btn');
                const logoutBtn = document.getElementById('logout-btn');
                const userMenuBtn = document.getElementById('user-menu-btn');
                
                if (loginBtn) {
                    loginBtn.addEventListener('click', () => {
                        authUI.showLogin();
                    });
                }
                
                if (registerBtn) {
                    registerBtn.addEventListener('click', () => {
                        authUI.showRegister();
                    });
                }
                
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', async () => {
                        try {
                            await authManager.logout();
                            showNotification('Logged out successfully!', 'success');
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);
                        } catch (error) {
                            showNotification('Error logging out: ' + error.message, 'error');
                        }
                    });
                }
                
                // Setup user menu toggle
                if (userMenuBtn) {
                    userMenuBtn.addEventListener('click', () => {
                        const menu = document.getElementById('user-menu');
                        if (menu) {
                            menu.classList.toggle('hidden');
                        }
                    });
                }
                
                // Close user menu when clicking outside
                document.addEventListener('click', (e) => {
                    const menu = document.getElementById('user-menu');
                    const btn = document.getElementById('user-menu-btn');
                    if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
                        menu.classList.add('hidden');
                    }
                });
                
                // Update UI based on authentication state
                function updateAuthUI() {
                    const user = authManager.getCurrentUser();
                    const notLoggedIn = document.getElementById('auth-not-logged-in');
                    const loggedIn = document.getElementById('auth-logged-in');
                    const authNotice = document.getElementById('auth-notice');
                    
                    if (user) {
                        // User is authenticated
                        if (notLoggedIn) notLoggedIn.classList.add('hidden');
                        if (loggedIn) loggedIn.classList.remove('hidden');
                        if (authNotice) authNotice.classList.add('hidden');
                        
                        // Update user display
                        const userName = document.getElementById('user-name');
                        const userInitial = document.getElementById('user-initial');
                        if (userName) userName.textContent = user.username;
                        if (userInitial) userInitial.textContent = user.username.charAt(0).toUpperCase();
                    } else {
                        // User is not authenticated
                        if (notLoggedIn) notLoggedIn.classList.remove('hidden');
                        if (loggedIn) loggedIn.classList.add('hidden');
                        if (authNotice) authNotice.classList.remove('hidden');
                    }
                }
                
                // Listen for auth state changes
                authManager.addListener(updateAuthUI);
                
                // Initial auth state update
                updateAuthUI();
                
                console.log('Authentication initialization complete');
            }
            
            // Start initialization
            initializeAuth();
        });
    </script>
</body>
</html>